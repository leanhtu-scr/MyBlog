<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chào các con !</title>
<style>
  :root{
    --bg:#000; --text:#fff; --muted:rgba(255,255,255,0.66);
    --glass: rgba(255,255,255,0.06);
    --accent:#ff3b30; --card-bg: rgba(0,0,0,0.45);
    --radius:12px; --max-width:920px;
  }
  [data-theme="light"]{
    --bg:#f5f5f7; --text:#0b0b0b; --muted:rgba(0,0,0,0.6); --glass: rgba(0,0,0,0.04); --card-bg: rgba(255,255,255,0.85);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  /* background video + fallback */
  #bgVideo{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;filter:brightness(.28)}
  #bgFallback{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-1;display:none}
  /* layout */
  header{position:relative;z-index:12;padding:12px 18px;display:flex;align-items:center;gap:12px;justify-content:space-between}
  .brand{font-weight:800;color:var(--accent);font-size:18px}
  .controls-top{display:flex;gap:8px;align-items:center}
  button,select,input,textarea{font-family:inherit}
  .app{position:relative;z-index:10;max-width:var(--max-width);margin:10px auto;padding:12px}
  .card{background:var(--card-bg);border-radius:var(--radius);padding:12px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .row{display:flex;gap:12px;align-items:center}
  .col{display:flex;flex-direction:column;gap:8px}
  .stage{display:flex;gap:16px;align-items:flex-start;margin-top:12px}
  .left{flex:1;min-width:300px}
  .right{width:320px}
  #composer textarea{min-height:110px;width:100%;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .btn{padding:8px 10px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.06);cursor:pointer;color:var(--text)}
  /* posts */
  #feed{max-height:68vh;overflow:hidden;border-radius:12px;padding:8px;position:relative}
  .post{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:10px;margin:10px 0;transition:transform .18s,box-shadow .18s}
  .post:hover{transform:translateY(-4px);box-shadow:0 8px 30px rgba(0,0,0,0.2)}
  .meta{font-size:13px;color:var(--muted);display:flex;gap:8px;align-items:center}
  .meta .author{display:flex;align-items:center;gap:8px}
  .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.06)}
  .reactions{display:flex;gap:8px;margin-top:8px}
  .reaction{cursor:pointer;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);display:inline-flex;align-items:center;gap:6px}
  .reaction.selected{transform:scale(1.08);box-shadow:0 6px 18px rgba(0,0,0,0.3);border-color:var(--accent)}
  .reactions .count{font-size:13px;color:var(--muted)}
  .comments{max-height:140px;overflow:hidden;padding-top:6px}
  .comment-list{display:flex;flex-direction:column-reverse;gap:6px;overflow-y:auto;padding:6px}
  .comment{background:rgba(255,255,255,0.03);padding:6px;border-radius:8px;opacity:0;transform:translateY(12px);animation:slideUp .28s forwards;display:flex;gap:8px;align-items:flex-start}
  .comment .c-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover}
  @keyframes slideUp{to{opacity:1;transform:none}}
  .fadeOut{animation:fadeOut 1s forwards}
  @keyframes fadeOut{to{opacity:0;height:0;margin:0;padding:0}}
  .music{position:fixed;left:12px;bottom:12px;z-index:20;background:rgba(0,0,0,0.55);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);display:flex;gap:8px;align-items:center}
  .music .title{min-width:160px}
  .auth-box{position:fixed;left:12px;top:88px;z-index:20;padding:10px;border-radius:10px;background:rgba(0,0,0,0.6);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.04)}
  input.input{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--text)}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);z-index:60}
  .notify{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;display:none;z-index:60}
  .tooltip{position:absolute;background:#222;padding:6px 8px;border-radius:6px;font-size:12px;color:#fff;pointer-events:none;transform:translate(-50%,-120%);white-space:nowrap;z-index:70;opacity:0;transition:opacity .12s}
  .reaction:hover .tooltip{opacity:1}
  @media(max-width:920px){ .stage{flex-direction:column}.right{width:100%} .app{padding:8px} .music .title{min-width:120px} }
</style>
</head>
<body data-theme="">

<!-- Background -->
<video id="bgVideo" autoplay muted loop playsinline>
  <source src="background.mp4" type="video/mp4" />
</video>
<img id="bgFallback" src="fallback.jpg" alt="fallback" style="display:none"/>

<header>
  <div class="brand">Mini Social — Pro</div>
  <div class="controls-top">
    <button id="toggleBg" class="btn">Tắt nền</button>
    <button id="themeToggle" class="btn">Switch Theme</button>
    <button id="btnLogout" class="btn" style="display:none">Đăng xuất</button>
  </div>
</header>

<div class="app">
  <div class="card row">
    <div style="flex:1">
      <!-- Auth box -->
      <div class="auth-box" id="authBox">
        <div id="registerPanel">
          <div style="font-weight:700;margin-bottom:6px">Tạo tài khoản</div>
          <input id="regUser" class="input" placeholder="Tên tài khoản (mọi kí tự)"><br>
          <input id="regPass" class="input" placeholder="Mật khẩu" type="password"><br>
          <input id="regAvatarUrl" class="input" placeholder="URL avatar (tùy chọn)"><br>
          <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
            <input id="regAvatarFile" type="file" accept="image/*" style="color:transparent">
            <button id="btnRegister" class="btn">Đăng ký</button>
            <button id="btnShowLogin" class="btn">Đến đăng nhập</button>
          </div>
        </div>

        <div id="loginPanel" style="display:none">
          <div style="font-weight:700;margin-bottom:6px">Đăng nhập</div>
          <input id="loginUser" class="input" placeholder="Tên tài khoản"><br>
          <input id="loginPass" class="input" placeholder="Mật khẩu" type="password"><br>
          <input id="loginAvatarUrl" class="input" placeholder="(tùy chọn - cập nhật avatar URL)"><br>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="btnLogin" class="btn">Đăng nhập</button>
            <button id="btnShowReg" class="btn">Đến đăng ký</button>
          </div>
          <div style="margin-top:8px">
            <input id="fpUser" class="input" placeholder="Tên tài khoản để reset mật khẩu">
            <button id="btnForgot" class="btn">Quên mật khẩu (mã=0)</button>
          </div>
        </div>
      </div>

      <!-- Composer + feed -->
      <div style="margin-top:12px">
        <div id="composer" class="card" style="display:none">
          <textarea id="contentInput" placeholder="Viết bài... (admin không giới hạn, user 1 bài/ngày)"></textarea>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <button id="btnPost" class="btn">Đăng</button>
            <button id="btnDelete" class="btn">Xóa bài hiện tại</button>
            <div style="margin-left:auto;color:var(--muted)" id="whoInfo"></div>
          </div>
        </div>

        <div id="feed" class="card" aria-live="polite">
          <div id="emptyHint" style="text-align:center;color:var(--muted);padding:30px">Chưa có bài viết — đăng bài đầu tiên nhé!</div>
        </div>
      </div>
    </div>

    <aside class="right">
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Music</div>
        <div class="music">
          <div style="display:flex;flex-direction:column">
            <div class="title" id="musicTitle">— Chưa chọn —</div>
            <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
              <button id="musicPrev" class="btn">⏮</button>
              <button id="musicPlay" class="btn">⏯</button>
              <button id="musicNext" class="btn">⏭</button>
              <button id="btnAddMusic" class="btn">+Add</button>
            </div>
            <select id="musicList" style="margin-top:8px"></select>
            <audio id="bgMusic" loop></audio>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Thông tin</div>
        <div style="font-size:14px;color:var(--muted)">Admin mặc định: <b>admin</b> / <b>admin</b></div>
        <div style="margin-top:8px;font-size:14px;color:var(--muted)">Avatar: upload hoặc URL. Reaction: 1 icon / người.</div>
      </div>
    </aside>
  </div>
</div>

<!-- small toast & big notific -->
<div id="toastRoot" aria-live="polite"></div>
<div id="bigNotif" class="notify"></div>

<script>
/* --------- Storage keys & helpers --------- */
const K_USERS = 'ms_pro_users_v2';
const K_POSTS = 'ms_pro_posts_v2';
const K_MUSIC = 'ms_pro_music_v2';
const K_SETTINGS = 'ms_pro_settings_v2';

const el = id => document.getElementById(id);
const escapeHtml = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

function load(k, fallback){ try{return JSON.parse(localStorage.getItem(k))||fallback}catch(e){return fallback} }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

function toast(msg, ms=2500){ const d=document.createElement('div');d.className='toast';d.innerText=msg;document.body.appendChild(d);setTimeout(()=>d.remove(),ms); }
function showNotif(txt,ms=3500){ const n=el('bigNotif'); n.innerText=txt; n.style.display='block'; setTimeout(()=>n.style.display='none',ms); }
function now(){ return Date.now(); }

/* --------- App state (load or defaults) --------- */
let users = load(K_USERS, {});
let posts = load(K_POSTS, []);
let musicList = load(K_MUSIC, [
  {url:'./deanhluongthien.mp3', title:'Để Anh Lương Thiện Remix'},
  {url:'./emcuoiroia.mp3', title:'Em Cưới Rồi À Remix'},
  {url:'./freemanxlowremix.mp3', title:'Free Man x Low Remix'},
]);
let settings = load(K_SETTINGS, { bgOn:true, theme:'dark', currentMusicIndex: null });

/* ensure admin exists */
if(!users['admin']) users['admin'] = { password:'admin', avatarUrl:'', avatarData:'', createdAt: now(), isAdmin:true, lastPostAt:0 };

/* save back */
save(K_USERS, users);
save(K_MUSIC, musicList);

/* UI refs */
const bgVideo = el('bgVideo'), bgFallback = el('bgFallback'), toggleBg = el('toggleBg'), themeToggle = el('themeToggle');
const btnLogout = el('btnLogout'), authBox = el('authBox'), registerPanel = el('registerPanel'), loginPanel = el('loginPanel');
const btnShowLogin = el('btnShowLogin'), btnShowReg = el('btnShowReg'), btnRegister = el('btnRegister'), btnLogin = el('btnLogin');
const btnForgot = el('btnForgot'), fpUser = el('fpUser');
const composer = el('composer'), contentInput = el('contentInput'), btnPost = el('btnPost'), btnDelete = el('btnDelete'), whoInfo = el('whoInfo');
const feed = el('feed'), emptyHint = el('emptyHint');
const musicSelect = el('musicList'), musicTitle = el('musicTitle'), bgMusic = el('bgMusic'), musicPlay = el('musicPlay');
const musicPrev = el('musicPrev'), musicNext = el('musicNext'), btnAddMusic = el('btnAddMusic');

/* runtime */
let currentUser = null; // {name,isAdmin}
let currentPostIndex = posts.length - 1;

/* ---------- THEME & BACKGROUND ---------- */
function applyTheme(){
  document.documentElement.setAttribute('data-theme', settings.theme === 'light' ? 'light' : '');
  themeToggle.innerText = settings.theme === 'light' ? 'Dark' : 'Light';
}
applyTheme();

toggleBg.onclick = ()=>{
  settings.bgOn = !settings.bgOn; save(K_SETTINGS, settings); applyBg();
};
function applyBg(){
  if(settings.bgOn){ bgVideo.style.display='block'; bgFallback.style.display='none'; toggleBg.innerText='Tắt nền'; }
  else { bgVideo.style.display='none'; bgFallback.style.display='block'; toggleBg.innerText='Bật nền'; }
}
applyBg();

bgVideo.addEventListener('error', ()=>{ settings.bgOn=false; save(K_SETTINGS,settings); applyBg(); toast('Video lỗi, dùng ảnh fallback'); });

themeToggle.onclick = ()=>{ settings.theme = settings.theme === 'light' ? 'dark' : 'light'; save(K_SETTINGS,settings); applyTheme(); };

/* ---------- MUSIC ---------- */
function populateMusic(){
  musicSelect.innerHTML = '';
  const o0 = document.createElement('option'); o0.value=''; o0.innerText='-- Chọn bài --'; musicSelect.appendChild(o0);
  musicList.forEach((m,i)=>{ const o=document.createElement('option'); o.value=i; o.innerText = m.title || m.url; musicSelect.appendChild(o); });
  if(settings.currentMusicIndex !== null && musicList[settings.currentMusicIndex]) {
    musicSelect.value = settings.currentMusicIndex;
    setMusicTitle(musicList[settings.currentMusicIndex].title);
    bgMusic.src = musicList[settings.currentMusicIndex].url;
  } else setMusicTitle('— Chưa chọn —');
}
populateMusic();

function setMusicTitle(t){ musicTitle.innerText = t || '— Chưa chọn —'; }
musicSelect.onchange = (e)=> {
  const idx = e.target.value;
  if(idx === ''){ bgMusic.pause(); bgMusic.src=''; setMusicTitle('— Chưa chọn —'); settings.currentMusicIndex = null; save(K_SETTINGS,settings); return; }
  playIndex(Number(idx));
};
function playIndex(idx){
  const m = musicList[idx]; if(!m) return;
  settings.currentMusicIndex = idx; save(K_SETTINGS,settings);
  bgMusic.src = m.url;
  bgMusic.play().catch(()=>toast('Autoplay bị chặn'));
  setMusicTitle(m.title || m.url);
}
musicPlay.onclick = ()=>{ if(bgMusic.paused) bgMusic.play().catch(()=>toast('Autoplay bị chặn')); else bgMusic.pause(); }
musicPrev.onclick = ()=>{ if(settings.currentMusicIndex == null) return; settings.currentMusicIndex = (settings.currentMusicIndex-1+musicList.length)%musicList.length; playIndex(settings.currentMusicIndex);}
musicNext.onclick = ()=>{ if(settings.currentMusicIndex == null) return; settings.currentMusicIndex = (settings.currentMusicIndex+1)%musicList.length; playIndex(settings.currentMusicIndex);}
btnAddMusic.onclick = ()=>{ const url = prompt('Dán URL mp3 (http/https):'); if(!url) return; const title = prompt('Tiêu đề (bỏ trống để lấy file name):') || url.split('/').pop(); musicList.push({url,title}); save(K_MUSIC,musicList); populateMusic(); toast('Đã thêm bài'); }

/* ---------- AUTH (register/login/avatar upload) ---------- */
el('btnShowLogin').onclick = ()=>{ registerPanel.style.display='none'; loginPanel.style.display='block'; };
el('btnShowReg').onclick = ()=>{ registerPanel.style.display='block'; loginPanel.style.display='none'; };

el('regAvatarFile').addEventListener('change', function(evt){
  const f = this.files && this.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = e=>{
    // store temporary data in input's dataset so register can read
    el('regAvatarUrl').value = ''; // clear URL field
    el('regAvatarUrl').dataset.data = e.target.result;
    toast('Ảnh đã load, sẽ lưu vào tài khoản khi đăng ký');
  };
  reader.readAsDataURL(f);
});

el('btnRegister').onclick = ()=>{
  const u = el('regUser').value.trim(), p = el('regPass').value;
  if(!u) return toast('Nhập tên tài khoản');
  if(users[u]) return toast('Tài khoản đã tồn tại');
  let avatarUrl = el('regAvatarUrl').value.trim();
  let avatarData = el('regAvatarUrl').dataset.data || '';
  users[u] = { password: p, avatarUrl: avatarUrl||'', avatarData: avatarData||'', createdAt: now(), isAdmin:false, lastPostAt:0 };
  save(K_USERS, users);
  toast('Đăng ký thành công — hãy đăng nhập');
  el('regUser').value=''; el('regPass').value=''; el('regAvatarUrl').value=''; delete el('regAvatarUrl').dataset.data;
  registerPanel.style.display='none'; loginPanel.style.display='block';
};

el('btnLogin').onclick = ()=>{
  const u = el('loginUser').value.trim(), p = el('loginPass').value;
  if(u === 'admin' && p === 'admin'){ currentUser = { name:'admin', isAdmin:true }; onLogin(); return; }
  if(!users[u] || users[u].password !== p){ toast('Sai thông tin đăng nhập'); return; }
  currentUser = { name: u, isAdmin: !!users[u].isAdmin };
  // optionally update avatar url if provided in login form
  const avatarUrlNew = el('loginAvatarUrl').value.trim();
  if(avatarUrlNew){ users[u].avatarUrl = avatarUrlNew; save(K_USERS, users); el('loginAvatarUrl').value=''; }
  onLogin();
};

function onLogin(){
  el('btnLogout').style.display = 'inline-block';
  el('authBox').style.display = 'none';
  composer.style.display = 'block';
  whoInfo.innerText = `Bạn: ${currentUser.name}${currentUser.isAdmin?' (admin)':''}`;
  renderFullFeed();
  toast('Đã đăng nhập: ' + currentUser.name, 1400);
}

el('btnLogout').onclick = ()=>{
  currentUser = null;
  el('authBox').style.display = 'block';
  composer.style.display = 'none';
  el('btnLogout').style.display = 'none';
  whoInfo.innerText = '';
  toast('Đã đăng xuất');
};

el('btnForgot').onclick = ()=>{
  const who = el('fpUser').value.trim() || prompt('Tên tài khoản:');
  if(!who) return;
  if(who === 'admin'){ toast('Không reset admin qua giao diện'); return; }
  if(!users[who]) return toast('Tài khoản không tồn tại');
  const code = prompt('Nhập mã đổi mật khẩu (mặc định: 0):');
  if(code === '0'){ const np = prompt('Nhập mật khẩu mới:'); users[who].password = np; save(K_USERS, users); toast('Đã đổi mật khẩu'); }
  else toast('Mã không đúng');
};

/* ---------- POSTS rendering, comments, reactions, views ---------- */

/* prune posts older than 24h */
function pruneOldPosts(){
  const cutoff = now() - 24*60*60*1000;
  const before = posts.length;
  posts = posts.filter(p => p.createdAt > cutoff);
  if(posts.length !== before) save(K_POSTS, posts);
}

/* helper: get avatar for username */
function getAvatarFor(user){
  const u = users[user];
  if(!u) return '';
  return u.avatarData || u.avatarUrl || '';
}

/* mark viewed: ensure only count once per user */
function markViewed(post){
  if(!currentUser) return;
  post.viewers = post.viewers || [];
  post.views = post.views || 0;
  if(!post.viewers.includes(currentUser.name)){
    post.viewers.push(currentUser.name);
    post.views++;
    save(K_POSTS, posts);
    // If views hit threshold for UI changes, we should update the post DOM header badge
    const node = feed.querySelector(`[data-post-id="${post.id}"]`);
    if(node){
      const flame = node.querySelector('.author-fire');
      if(post.views >= 10){
        if(!flame){
          const f = document.createElement('span'); f.className='author-fire'; f.textContent=' 🔥';
          node.querySelector('.meta .author .author-name').appendChild(f);
        }
      }
      // update views display
      const viewsNode = node.querySelector('.views-count');
      if(viewsNode) viewsNode.textContent = `👁 ${post.views}`;
    }
  }
}

/* create a post DOM node */
function createPostNode(p){
  const node = document.createElement('div'); node.className='post'; node.dataset.postId = p.id;
  // header with avatar, author, time, views
  const header = document.createElement('div'); header.className='meta';
  const authorWrap = document.createElement('div'); authorWrap.className='author';
  const avatarImg = document.createElement('img'); avatarImg.className='avatar';
  const av = getAvatarFor(p.author);
  avatarImg.src = av || 'data:image/svg+xml;base64,'+btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#666"/></svg>`);
  avatarImg.alt = p.author;
  const nameSpan = document.createElement('span'); nameSpan.className='author-name'; nameSpan.innerText = p.author;
  authorWrap.appendChild(avatarImg); authorWrap.appendChild(nameSpan);
  header.appendChild(authorWrap);

  // time and views
  const rightMeta = document.createElement('div');
  const timeSpan = document.createElement('span'); timeSpan.style.color = 'var(--muted)';
  timeSpan.innerText = new Date(p.createdAt).toLocaleString();
  const viewsSpan = document.createElement('span'); viewsSpan.className='views-count'; viewsSpan.style.marginLeft='10px'; viewsSpan.style.color='var(--muted)';
  viewsSpan.innerText = `👁 ${p.views||0}`;
  rightMeta.appendChild(timeSpan); rightMeta.appendChild(viewsSpan);
  header.appendChild(rightMeta);

  // append header
  node.appendChild(header);

  // content
  const content = document.createElement('div'); content.style.marginTop='8px'; content.innerHTML = `<div style="white-space:pre-wrap">${escapeHtml(p.content)}</div>`;
  node.appendChild(content);

  // reactions row
  const reactionsWrap = document.createElement('div'); reactionsWrap.className='reactions';
  const emojis = ['👍','❤️','😂','🔥','😮','🎉'];
  emojis.forEach(e=>{
    const btn = document.createElement('div'); btn.className='reaction'; btn.dataset.emoji = e;
    const emojiSpan = document.createElement('span'); emojiSpan.innerText = e;
    const countSpan = document.createElement('span'); countSpan.className='count'; countSpan.style.marginLeft='6px'; countSpan.innerText = p.reactions && p.reactions[e] ? p.reactions[e] : 0;
    const tip = document.createElement('div'); tip.className='tooltip'; tip.innerText = `React ${e}`;
    btn.appendChild(emojiSpan); btn.appendChild(countSpan); btn.appendChild(tip);
    // click behavior: ensure user only one emoji per post
    btn.addEventListener('click', ()=>{
      if(!currentUser) return toast('Đăng nhập để react');
      p.userReactions = p.userReactions || {};
      const prev = p.userReactions[currentUser.name] || null;
      if(prev === e){
        // remove reaction
        p.userReactions[currentUser.name] = null;
        p.reactions[e] = Math.max(0, (p.reactions[e]||0) - 1);
        btn.classList.remove('selected');
        countSpan.innerText = p.reactions[e]||0;
      } else {
        // change reaction: decrement previous if any, increment new
        if(prev){
          p.reactions[prev] = Math.max(0, (p.reactions[prev]||0) - 1);
          // update prev button UI
          const prevBtn = node.querySelector(`.reaction[data-emoji="${prev}"]`);
          if(prevBtn) prevBtn.classList.remove('selected'), prevBtn.querySelector('.count').innerText = p.reactions[prev]||0;
        }
        p.userReactions[currentUser.name] = e;
        p.reactions[e] = (p.reactions[e]||0) + 1;
        btn.classList.add('selected');
        countSpan.innerText = p.reactions[e];
        // pulse animation
        btn.animate([{transform:'scale(1)'},{transform:'scale(1.08)'},{transform:'scale(1)'}], {duration:260});
      }
      save(K_POSTS, posts);
    });
    reactionsWrap.appendChild(btn);
  });
  node.appendChild(reactionsWrap);

  // reactions summary
  const sum = document.createElement('div'); sum.style.marginTop='8px'; sum.style.color='var(--muted)';
  const entries = Object.entries(p.reactions||{}).filter(([k,v])=>v>0);
  sum.innerText = entries.length ? entries.map(([k,v])=>`${k}:${v}`).join(' ') : '';
  node.appendChild(sum);

  // comments
  const commentsWrap = document.createElement('div'); commentsWrap.className='comments';
  const list = document.createElement('div'); list.className='comment-list'; list.id = `c${p.id}`;
  commentsWrap.appendChild(list);
  node.appendChild(commentsWrap);

  // comment input + buttons
  const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginTop='8px'; row.style.alignItems='center';
  const input = document.createElement('input'); input.className='input'; input.placeholder='Bình luận...'; input.style.flex='1'; input.id = `in${p.id}`;
  const sendBtn = document.createElement('button'); sendBtn.className='btn'; sendBtn.textContent='Gửi'; sendBtn.onclick = ()=>addComment(p.id);
  const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='Xóa'; delBtn.onclick = ()=>deletePost(p.id);
  row.appendChild(input); row.appendChild(sendBtn); row.appendChild(delBtn);
  node.appendChild(row);

  // initial render of comments (newest at bottom in data, but list is column-reverse)
  (p.comments || []).forEach(c=> appendCommentDom(list, c.user, c.text, c.ts));

  // mark viewed if applicable
  markViewed(p);

  // if views >= 10 show fire badge after author name
  if((p.views||0) >= 10){
    const nameSpan = node.querySelector('.author-name');
    if(nameSpan && !node.querySelector('.author-fire')){
      const f = document.createElement('span'); f.className='author-fire'; f.textContent=' 🔥';
      nameSpan.appendChild(f);
    }
  }

  return node;
}

/* append comment DOM */
function appendCommentDom(listEl, user, text, ts){
  const d = document.createElement('div'); d.className='comment';
  // avatar + text
  const avImg = document.createElement('img'); avImg.className='c-avatar';
  const avat = users[user] ? (users[user].avatarData || users[user].avatarUrl || '') : '';
  avImg.src = avat || 'data:image/svg+xml;base64,'+btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#888"/></svg>`);
  avImg.alt = user;
  const txt = document.createElement('div'); txt.style.flex='1'; txt.innerText = `${user}: ${text}`;
  d.appendChild(avImg); d.appendChild(txt);
  // insert at top because of column-reverse visual
  listEl.insertBefore(d, listEl.firstChild);
  // schedule fade out
  setTimeout(()=>{ d.classList.add('fadeOut'); setTimeout(()=>d.remove(),1000); }, 15000);
  // keep scroll showing newest (because column-reverse)
  listEl.scrollTop = 0;
}

/* render full feed */
function renderFullFeed(){
  pruneOldPosts();
  feed.innerHTML = '';
  if(posts.length === 0){ emptyHint.style.display = 'block'; return; } else emptyHint.style.display='none';
  posts.forEach(p=>{ const n = createPostNode(p); feed.appendChild(n); });
  // show newest by default (visually we keep all visible; navigation can hide/unhide)
  currentPostIndex = Math.max(0, posts.length - 1);
  updateVisiblePost();
}

/* add comment */
function addComment(postId){
  if(!currentUser) return toast('Đăng nhập để bình luận');
  const inp = el('in'+postId); if(!inp) return;
  const text = inp.value.trim(); if(!text) return;
  const p = posts.find(x=>x.id===postId);
  p.comments = p.comments || [];
  p.comments.push({ user: currentUser.name, text, ts: now() });
  save(K_POSTS, posts);
  // append DOM
  const listEl = el('c'+postId); if(listEl) appendCommentDom(listEl, currentUser.name, text, now());
  inp.value = '';
}

/* add post */
function addPost(){
  if(!currentUser) return toast('Đăng nhập để đăng bài');
  const content = contentInput.value.trim(); if(!content) return toast('Nội dung rỗng');
  if(!currentUser.isAdmin){
    const last = users[currentUser.name].lastPostAt || 0;
    if(now() - last < 24*60*60*1000) return toast('Bạn chỉ được đăng 1 lần trong 24h');
  }
  if(!confirm('Bạn có chắc muốn đăng?')) return;
  const post = { id: Math.floor(Math.random()*1e9), author: currentUser.name, content, createdAt: now(), reactions:{}, userReactions:{}, comments:[], views:0, viewers:[] };
  posts.push(post); users[currentUser.name].lastPostAt = now();
  save(K_POSTS, posts); save(K_USERS, users);
  const node = createPostNode(post);
  feed.appendChild(node);
  contentInput.value = '';
  emptyHint.style.display = 'none';
  showToastSmall('Đã đăng bài');
}

/* delete post by id */
function deletePost(id){
  const p = posts.find(x=>x.id===id); if(!p) return;
  if(!currentUser) return toast('Đăng nhập để xóa');
  if(currentUser.isAdmin || p.author === currentUser.name){
    if(!confirm('Xác nhận xóa bài?')) return;
    posts = posts.filter(x=>x.id!==id);
    save(K_POSTS, posts);
    const node = feed.querySelector(`[data-post-id="${id}"]`); if(node) node.remove();
  } else toast('Bạn không có quyền xóa bài này');
}

/* delete current visible (keeps backward compatibility) */
function deleteCurrentVisible(){
  const last = feed.querySelector('.post:last-child'); if(!last) return;
  const id = Number(last.dataset.postId); deletePost(id);
}

/* show/hide visible post via currentPostIndex */
function updateVisiblePost(){
  const nodes = feed.querySelectorAll('.post');
  nodes.forEach((n,i)=> n.style.display = (i === currentPostIndex ? 'block' : 'none'));
}

/* swipe support */
let tsX = null;
feed.addEventListener('touchstart', e=>{ tsX = e.touches[0].clientX; });
feed.addEventListener('touchend', e=>{ if(tsX===null) return; const dx = e.changedTouches[0].clientX - tsX; if(Math.abs(dx)>60){ if(dx<0){ currentPostIndex = Math.min(currentPostIndex+1, posts.length-1); } else { currentPostIndex = Math.max(currentPostIndex-1, 0); } updateVisiblePost(); } tsX = null; });

document.addEventListener('keydown', e=>{ if(e.key==='ArrowRight'){ currentPostIndex = Math.min(currentPostIndex+1, posts.length-1); updateVisiblePost(); } if(e.key==='ArrowLeft'){ currentPostIndex = Math.max(currentPostIndex-1, 0); updateVisiblePost(); } });

/* markViewed when a post node is created or when it becomes visible (we call markViewed in createPostNode already). */
/* Periodic cleanup of faded comments nodes */
setInterval(()=>{ document.querySelectorAll('.comment.fadeOut').forEach(n=>n.remove()); }, 8000);

/* random compliment */
setInterval(()=>{ const keys = Object.keys(users); if(keys.length===0) return; const who = keys[Math.floor(Math.random()*keys.length)]; showNotif(who + ' thật đẹp 💖', 4000); }, 10*60*1000);

/* small toast util */
function showToastSmall(t){ const d=document.createElement('div'); d.className='toast'; d.innerText=t; document.body.appendChild(d); setTimeout(()=>d.remove(),1800); }

/* init */
function init(){
  pruneOldPosts();
  renderFullFeed();
  composer.style.display = 'none';
  btnLogout.style.display = 'none';
  btnPost.onclick = addPost;
  btnDelete.onclick = deleteCurrentVisible;
  populateMusic();
  // restore settings
  applyBg();
  applyTheme();
  // draft autosave
  contentInput.addEventListener('input', (function(){ let t; return ()=>{ clearTimeout(t); t=setTimeout(()=>localStorage.setItem('ms_draft', contentInput.value), 800); } })());
  const draft = localStorage.getItem('ms_draft'); if(draft) contentInput.value = draft;
}
init();

/* expose debug */
window._ms = {users, posts, musicList, settings, saveAll: ()=>{ save(K_USERS, users); save(K_POSTS, posts); save(K_MUSIC, musicList); save(K_SETTINGS, settings); }};

</script>
</body>
</html>
