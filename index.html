<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini Social ‚Äì 1 file HTML</title>
  <style>
    :root{
      --bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#0ea5e9;--danger:#ef4444;--ok:#16a34a;--border:#e5e7eb;--chip:#f1f5f9
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#fff, var(--bg));font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;color:var(--text)}
    .container{max-width:960px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(2,8,23,.05)}
    .p-16{padding:16px}.p-20{padding:20px}.p-24{padding:24px}
    .mb-8{margin-bottom:8px}.mb-12{margin-bottom:12px}.mb-16{margin-bottom:16px}.mb-20{margin-bottom:20px}
    .row{display:flex;gap:12px;align-items:center}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.ghost{background:transparent}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .input, .textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .textarea{min-height:120px;resize:vertical}
    .tabs{display:grid;grid-template-columns:1fr 1fr 1fr;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .tab{padding:10px 12px;text-align:center;background:#fff;cursor:pointer;font-weight:600;border-right:1px solid var(--border)}
    .tab:last-child{border-right:none}
    .tab.active{background:var(--chip)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:var(--chip);border:1px solid var(--border);border-radius:999px;font-size:12px;color:#0f172a}
    header.sticky{position:sticky;top:0;backdrop-filter:saturate(180%) blur(8px);background:rgba(255,255,255,.75);border-bottom:1px solid var(--border);z-index:10}
    .muted{color:var(--muted)}
    .center{display:grid;place-items:center;min-height:100vh;padding:16px}
    .hidden{display:none}
    /* Carousel */
    .carousel{position:relative}
    .dots{display:flex;justify-content:center;gap:6px;padding:10px}
    .dot{height:6px;width:24px;border-radius:999px;background:#cbd5e1}
    .dot.active{background:#0f172a}
    .arrow{position:absolute;top:0;bottom:0;display:flex;align-items:center;padding:6px}
    .arrow.left{left:0}.arrow.right{right:0}
    .comment-box{height:220px;overflow:auto;padding:8px 12px}
    .comment{font-size:14px;margin:6px 0}
    .emoji{border:1px solid var(--border);background:#fff;border-radius:20px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px;cursor:pointer}
    .emoji.active{outline:2px solid var(--primary)}
    @media (max-width:560px){.row{flex-wrap:wrap}}
  </style>
</head>
<body>
  <header class="sticky">
    <div class="container row-between p-16">
      <div class="row">
        <span class="badge">Mini Social</span>
        <span class="muted" id="welcome"></span>
      </div>
      <div class="row">
        <button class="btn" id="logoutBtn">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </header>

  <!-- AUTH SCREEN -->
  <section id="auth" class="center">
    <div class="card p-24" style="width:min(680px, 100%)">
      <h2 class="mb-16">ƒêƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c</h2>
      <div class="tabs mb-16">
        <div class="tab active" data-tab="login">ƒêƒÉng nh·∫≠p</div>
        <div class="tab" data-tab="register">ƒêƒÉng k√Ω</div>
        <div class="tab" data-tab="forgot">Qu√™n m·∫≠t kh·∫©u</div>
      </div>
      <div id="login" class="tabpane">
        <div class="mb-12"><input id="liUser" class="input" placeholder="T√™n t√†i kho·∫£n"/></div>
        <div class="mb-12"><input id="liPass" type="password" class="input" placeholder="M·∫≠t kh·∫©u"/></div>
        <button id="loginBtn" class="btn primary" style="width:100%">ƒêƒÉng nh·∫≠p</button>
        <p class="muted mb-0" style="margin-top:10px">G·ª£i √Ω: admin / admin</p>
      </div>
      <div id="register" class="tabpane hidden">
        <div class="mb-12"><input id="reUser" class="input" placeholder="T√™n t√†i kho·∫£n"/></div>
        <div class="mb-12"><input id="rePass" type="password" class="input" placeholder="M·∫≠t kh·∫©u"/></div>
        <div class="mb-12"><input id="rePass2" type="password" class="input" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"/></div>
        <button id="registerBtn" class="btn primary" style="width:100%">T·∫°o t√†i kho·∫£n</button>
        <div id="recoveryNote" class="muted" style="margin-top:10px"></div>
      </div>
      <div id="forgot" class="tabpane hidden">
        <div class="mb-12"><input id="foUser" class="input" placeholder="T√™n t√†i kho·∫£n"/></div>
        <div class="mb-12"><input id="foCode" class="input" placeholder="M√£ kh√¥i ph·ª•c"/></div>
        <div class="mb-12"><input id="foNew" type="password" class="input" placeholder="M·∫≠t kh·∫©u m·ªõi"/></div>
        <button id="forgotBtn" class="btn primary" style="width:100%">ƒê·ªïi m·∫≠t kh·∫©u</button>
      </div>
    </div>
  </section>

  <!-- MAIN SCREEN -->
  <section id="main" class="container hidden">
    <div id="adminComposer" class="card p-20 mb-16 hidden">
      <div class="row-between mb-12">
        <h3>So·∫°n b√†i vi·∫øt (ch·ªâ admin)</h3>
        <span class="muted">B√†i t·ª± xo√° sau 15 gi·ªù</span>
      </div>
      <textarea id="postText" class="textarea" placeholder="Vi·∫øt g√¨ ƒë√≥‚Ä¶"></textarea>
      <div class="row-between" style="margin-top:10px">
        <span></span>
        <button id="postBtn" class="btn primary">ƒêƒÉng</button>
      </div>
    </div>

    <div class="card p-0" id="feedCard">
      <div class="p-16 row-between">
        <h3 class="mb-0">B√†i ƒëƒÉng (vu·ªët sang ph·∫£i ƒë·ªÉ xem b√†i kh√°c)</h3>
        <div class="muted" id="countdown"></div>
      </div>
      <hr style="border:none;border-top:1px solid var(--border);margin:0"/>
      <div id="carousel" class="carousel" style="min-height:220px">
        <div class="arrow left"><button id="prevBtn" class="btn ghost">‚óÄ</button></div>
        <div class="arrow right"><button id="nextBtn" class="btn ghost">‚ñ∂</button></div>
        <div id="postContainer" class="p-20"></div>
        <div class="dots" id="dots"></div>
      </div>
    </div>
  </section>

  <template id="postTemplate">
    <div class="p-12" style="display:grid;gap:12px">
      <div class="row-between">
        <div class="row">
          <span class="badge">B√†i c·ªßa admin</span>
          <span class="muted" data-el="created"></span>
        </div>
        <div class="row" style="gap:8px">
          <span class="muted">C√≤n l·∫°i: <b data-el="left"></b></span>
          <button class="btn danger hidden" data-el="deleteBtn">Xo√° b√†i vi·∫øt</button>
        </div>
      </div>
      <div style="font-size:18px;line-height:1.5;white-space:pre-wrap" data-el="content"></div>
      <div class="row" data-el="emojis" style="flex-wrap:wrap;gap:8px"></div>
      <div class="card p-12">
        <div class="row-between mb-8">
          <strong>B√¨nh lu·∫≠n (ki·ªÉu livestream)</strong>
          <span class="badge"><span data-el="cCount">0</span> b√¨nh lu·∫≠n</span>
        </div>
        <div class="comment-box" data-el="cBox"></div>
        <div class="row" style="margin-top:8px">
          <input class="input" data-el="cInput" placeholder="Nh·∫≠p b√¨nh lu·∫≠n v√† nh·∫•n Enter"/>
          <button class="btn" data-el="cSend">G·ª≠i</button>
        </div>
      </div>
    </div>
  </template>

  <script>
    // ==========================
    // Utilities & Storage
    // ==========================
    const LS_KEYS = { users:"mini_social_users", session:"mini_social_session", posts:"mini_social_posts" };
    const EMOJIS = ["üëç","‚ù§Ô∏è","üòÇ","üòÆ","üò¢","üî•","üëè","üéâ"]; // c·∫£m x√∫c
    const EXP_MS = 15*60*60*1000; // 15 gi·ªù

    const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
    const load = (k, fb)=> { try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? fb }catch{ return fb } };

    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function fmtTime(ts){ return new Date(ts).toLocaleString() }
    function fmtLeft(ms){ ms=Math.max(0,ms); const s=Math.floor(ms/1000); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const ss=s%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}` }

    function purgeExpired(posts){ const now=Date.now(); const kept = posts.filter(p=> now - p.createdAt < EXP_MS ); if(kept.length!==posts.length) save(LS_KEYS.posts, kept); return kept }

    async function ensureAdmin(){
      const users = load(LS_KEYS.users, []);
      if(!users.some(u=>u.username==='admin')){
        users.push({username:'admin', password: await sha256('admin'), role:'admin', recovery: crypto.randomUUID().slice(0,8)});
        save(LS_KEYS.users, users);
      }
    }

    // ==========================
    // App State
    // ==========================
    const state = {
      users: load(LS_KEYS.users, []),
      session: load(LS_KEYS.session, null),
      posts: purgeExpired(load(LS_KEYS.posts, [])),
      index: 0,
      touch:{startX:0,dx:0}
    };

    // Elements
    const el = (id)=> document.getElementById(id);
    const $auth = el('auth');
    const $main = el('main');
    const $welcome = el('welcome');
    const $logoutBtn = el('logoutBtn');

    const $tabs = document.querySelectorAll('.tab');
    const $loginPane = el('login');
    const $registerPane = el('register');
    const $forgotPane = el('forgot');

    const $adminComposer = el('adminComposer');
    const $postText = el('postText');
    const $postBtn = el('postBtn');

    const $carousel = el('carousel');
    const $postContainer = el('postContainer');
    const $dots = el('dots');
    const $prevBtn = el('prevBtn');
    const $nextBtn = el('nextBtn');
    const $countdown = el('countdown');

    const $liUser = el('liUser');
    const $liPass = el('liPass');
    const $loginBtn = el('loginBtn');

    const $reUser = el('reUser');
    const $rePass = el('rePass');
    const $rePass2 = el('rePass2');
    const $registerBtn = el('registerBtn');
    const $recoveryNote = el('recoveryNote');

    const $foUser = el('foUser');
    const $foCode = el('foCode');
    const $foNew = el('foNew');
    const $forgotBtn = el('forgotBtn');

    // ==========================
    // UI Helpers
    // ==========================
    function notify(msg, type='info'){
      const bar = document.createElement('div');
      bar.textContent = msg;
      bar.style.cssText = `position:fixed;left:50%;top:20px;transform:translateX(-50%);background:${type==='error'?'#ef4444':type==='ok'?'#16a34a':'#0ea5e9'};color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:9999`;
      document.body.appendChild(bar);
      setTimeout(()=>bar.remove(), 1800);
    }

    function setSession(s){ state.session = s; save(LS_KEYS.session, s); render(); }
    function setUsers(u){ state.users = u; save(LS_KEYS.users, u); }
    function setPosts(p){ state.posts = p; save(LS_KEYS.posts, p); renderPost(); }

    // ==========================
    // Auth Logic
    // ==========================
    $tabs.forEach(t=> t.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      $loginPane.classList.add('hidden');
      $registerPane.classList.add('hidden');
      $forgotPane.classList.add('hidden');
      const pane = document.getElementById(t.dataset.tab);
      pane.classList.remove('hidden');
    }));

    $loginBtn.addEventListener('click', async ()=>{
      const u = state.users.find(x=>x.username === $liUser.value.trim());
      if(!u){ notify('T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i','error'); return }
      const hashed = await sha256($liPass.value);
      if(hashed !== u.password){ notify('Sai m·∫≠t kh·∫©u','error'); return }
      setSession({username:u.username, role:u.role});
      notify('ƒêƒÉng nh·∫≠p th√†nh c√¥ng','ok');
    });

    $registerBtn.addEventListener('click', async ()=>{
      const username = $reUser.value.trim();
      const pass = $rePass.value; const pass2 = $rePass2.value;
      if(!username || !pass){ notify('ƒêi·ªÅn ƒë·ªß th√¥ng tin','error'); return }
      if(pass !== pass2){ notify('M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp','error'); return }
      if(state.users.some(u=>u.username===username)){ notify('T√™n t√†i kho·∫£n ƒë√£ t·ªìn t·∫°i','error'); return }
      const rec = crypto.randomUUID().slice(0,8);
      const user = {username, password: await sha256(pass), role:'user', recovery:rec};
      setUsers([...state.users, user]);
      $recoveryNote.textContent = `M√£ kh√¥i ph·ª•c c·ªßa b·∫°n: ${rec} (h√£y l∆∞u l·∫°i).`;
      notify('ƒêƒÉng k√Ω th√†nh c√¥ng ‚Äì h√£y ƒëƒÉng nh·∫≠p','ok');
      // chuy·ªÉn v·ªÅ tab ƒëƒÉng nh·∫≠p
      document.querySelector('.tab[data-tab="login"]').click();
    });

    $forgotBtn.addEventListener('click', async ()=>{
      const uidx = state.users.findIndex(u=>u.username===$foUser.value.trim());
      if(uidx===-1){ notify('Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n','error'); return }
      const user = state.users[uidx];
      if(user.recovery !== $foCode.value.trim()){ notify('M√£ kh√¥i ph·ª•c kh√¥ng ƒë√∫ng','error'); return }
      const newPw = await sha256($foNew.value);
      const copy = [...state.users];
      copy[uidx] = {...user, password:newPw};
      setUsers(copy);
      notify('ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng','ok');
      document.querySelector('.tab[data-tab="login"]').click();
    });

    $logoutBtn.addEventListener('click', ()=>{ setSession(null); notify('ƒê√£ ƒëƒÉng xu·∫•t') });

    // ==========================
    // Posts Logic
    // ==========================
    function postByAdmin(content){
      const p = { id: crypto.randomUUID(), content: content.trim(), createdAt: Date.now(), reactions:{}, comments:[] };
      setPosts([p, ...state.posts]);
      state.index = 0;
      notify('ƒê√£ ƒëƒÉng b√†i','ok');
    }

    $postBtn.addEventListener('click', ()=>{
      const t = $postText.value.trim(); if(!t){ notify('N·ªôi dung tr·ªëng','error'); return }
      postByAdmin(t); $postText.value='';
    });

    // Swipe events (vu·ªët sang ph·∫£i ƒë·ªÉ xem b√†i kh√°c)
    $carousel.addEventListener('touchstart', (e)=>{ state.touch.startX = e.touches[0].clientX; state.touch.dx=0 });
    $carousel.addEventListener('touchmove', (e)=>{ state.touch.dx = e.touches[0].clientX - state.touch.startX });
    $carousel.addEventListener('touchend', ()=>{
      if(state.touch.dx > 50){ // swipe right -> next
        state.index = Math.min(state.posts.length-1, state.index+1); renderPost();
      } else if(state.touch.dx < -50){ // swipe left -> prev
        state.index = Math.max(0, state.index-1); renderPost();
      }
    });

    $prevBtn.addEventListener('click', ()=>{ state.index = Math.max(0, state.index-1); renderPost() });
    $nextBtn.addEventListener('click', ()=>{ state.index = Math.min(state.posts.length-1, state.index+1); renderPost() });

    function toggleReact(post, emoji){
      const reactions = {...post.reactions};
      const arr = new Set(reactions[emoji] || []);
      const me = state.session.username;
      if(arr.has(me)) arr.delete(me); else arr.add(me);
      reactions[emoji] = Array.from(arr);
      const newPosts = state.posts.map(p=> p.id===post.id ? {...p, reactions} : p);
      setPosts(newPosts);
    }

    function addComment(post, text){
      const c = { id: crypto.randomUUID(), by: state.session.username, text, at: Date.now() };
      const newPosts = state.posts.map(p=> p.id===post.id ? {...p, comments:[...p.comments, c]} : p);
      setPosts(newPosts);
    }

    function deletePost(post){
      if(!confirm('Xo√° b√†i vi·∫øt n√†y?')) return;
      const newPosts = state.posts.filter(p=> p.id!==post.id);
      setPosts(newPosts);
      state.index = 0;
      notify('ƒê√£ xo√° b√†i vi·∫øt','ok');
    }

    // ==========================
    // Rendering
    // ==========================
    function render(){
      // ensure admin account
      ensureAdmin().then(()=>{ state.users = load(LS_KEYS.users, []) });

      // Auth/Main visibility
      if(state.session){
        $auth.classList.add('hidden');
        $main.classList.remove('hidden');
        $welcome.textContent = `Xin ch√†o, ${state.session.username}${state.session.role==='admin'?' (admin)':''}`;
        $adminComposer.classList.toggle('hidden', state.session.role!=='admin');
      } else {
        $auth.classList.remove('hidden');
        $main.classList.add('hidden');
        $welcome.textContent = '';
      }
      renderPost();
    }

    function renderPost(){
      // purge expired regularly
      state.posts = purgeExpired(state.posts);

      // sort newest first
      state.posts.sort((a,b)=> b.createdAt - a.createdAt);
      if(state.index >= state.posts.length) state.index = Math.max(0, state.posts.length-1);

      $dots.innerHTML = '';
      if(state.posts.length===0){
        $postContainer.innerHTML = `<div class="p-20 muted">Ch∆∞a c√≥ b√†i ƒëƒÉng h·ª£p l·ªá (b√†i c≈© h∆°n 15 gi·ªù s·∫Ω t·ª± xo√°).</div>`;
        $countdown.textContent = '';
        return;
      }

      state.posts.forEach((p,i)=>{
        const d = document.createElement('div'); d.className = 'dot'+(i===state.index?' active':''); $dots.appendChild(d);
      });

      const post = state.posts[state.index];
      const tpl = document.getElementById('postTemplate');
      const node = tpl.content.cloneNode(true);
      const $created = node.querySelector('[data-el="created"]');
      const $left = node.querySelector('[data-el="left"]');
      const $content = node.querySelector('[data-el="content"]');
      const $emojis = node.querySelector('[data-el="emojis"]');
      const $del = node.querySelector('[data-el="deleteBtn"]');
      const $cBox = node.querySelector('[data-el="cBox"]');
      const $cInput = node.querySelector('[data-el="cInput"]');
      const $cSend = node.querySelector('[data-el="cSend"]');
      const $cCount = node.querySelector('[data-el="cCount"]');

      $created.textContent = `ƒêƒÉng l√∫c ${fmtTime(post.createdAt)}`;
      $content.textContent = post.content;

      // emojis
      EMOJIS.forEach(e=>{
        const count = (post.reactions?.[e]||[]).length;
        const meActive = post.reactions?.[e]?.includes(state.session?.username);
        const btn = document.createElement('button');
        btn.className = 'emoji'+(meActive?' active':'');
        btn.innerHTML = `<span style="font-size:18px">${e}</span><span>${count}</span>`;
        btn.addEventListener('click', ()=>{ if(!state.session) return notify('H√£y ƒëƒÉng nh·∫≠p'); toggleReact(post,e) });
        $emojis.appendChild(btn);
      });

      // comments
      $cCount.textContent = post.comments.length;
      $cBox.innerHTML = '';
      post.comments.forEach(c=>{
        const line = document.createElement('div'); line.className='comment';
        const time = new Date(c.at).toLocaleTimeString();
        line.innerHTML = `<strong>${c.by}</strong> <span class="muted">${time}:</span> <span>${c.text}</span>`;
        $cBox.appendChild(line);
      });
      $cBox.scrollTop = $cBox.scrollHeight;

      function send(){
        const t = $cInput.value.trim(); if(!t) return; if(!state.session){ notify('H√£y ƒëƒÉng nh·∫≠p'); return }
        addComment(post,t); $cInput.value='';
      }
      $cSend.addEventListener('click', send);
      $cInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});

      // delete button visibility
      if(state.session?.role==='admin'){ $del.classList.remove('hidden'); $del.addEventListener('click', ()=> deletePost(post)); }

      $postContainer.innerHTML = '';
      $postContainer.appendChild(node);

      // Update countdown label at header for current post
      updateCountdown();
    }

    function updateCountdown(){
      if(state.posts.length===0){ $countdown.textContent=''; return }
      const p = state.posts[state.index];
      const left = EXP_MS - (Date.now() - p.createdAt);
      $countdown.textContent = left>0 ? `C√≤n l·∫°i: ${fmtLeft(left)}` : '';
      // also update the small label inside card
      const small = $postContainer.querySelector('[data-el="left"]');
      if(small) small.textContent = fmtLeft(left);
    }

    // Timers
    setInterval(()=>{ updateCountdown(); }, 1000);
    setInterval(()=>{ setPosts(purgeExpired(state.posts)); }, 30000);

    // Init
    (async function init(){
      await ensureAdmin();
      state.users = load(LS_KEYS.users, []);
      render();
    })();
  </script>
</body>
</html>
