<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ƒê·∫°i H·ªôi V√µ Thu·∫≠t</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--card:rgba(255,255,255,.85);--cardDark:rgba(18,18,18,.78)}
    .glass{backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px)}
    #bgVideo{position:fixed;right:0;bottom:0;min-width:100%;min-height:100%;object-fit:cover;z-index:-2}
    .bg-overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.25));z-index:-1;transition:background .2s}
    .post-grid{scroll-snap-type:x mandatory}
    .post-card{scroll-snap-align:center}
    .emoji-bubble{position:absolute; bottom:60px; left:50%; transform:translateX(-50%); display:none}
    .comment-stream{max-height:240px; overflow-y:auto}
    .admin-only{display:none}
  </style>
</head>
<body class="min-h-screen text-slate-900 dark:bg-neutral-950 dark:text-slate-100">

  <!-- ===== Background video (Code 1) ===== -->
  <video autoplay muted loop playsinline id="bgVideo">
    <source src="background.mp4" type="video/mp4">
  </video>
  <div class="bg-overlay" id="bgOverlay"></div>

  <!-- ===== Top Bar ===== -->
  <header class="glass sticky top-0 z-30">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl">ü•ã</span>
        <h1 class="text-xl font-bold">ƒê·∫°i H·ªôi V√µ Thu·∫≠t</h1>
        <span id="badgeRandom" class="hidden ml-3 px-2.5 py-1 rounded-full text-xs font-semibold bg-indigo-600 text-white"></span>
      </div>
      <div class="flex items-center gap-2">
        <span id="onlineCount" class="text-sm opacity-90">0 online</span>
        <button id="themeToggle" class="px-3 py-1.5 rounded-xl bg-black/70 text-white dark:bg-white/20">üåó</button>
        <button id="bgToggle" class="px-3 py-1.5 rounded-xl bg-black/70 text-white dark:bg-white/20">T·∫Øt n·ªÅn</button>
        <button id="logoutBtn" class="px-3 py-1.5 rounded-xl bg-red-600 text-white hidden">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </header>

  <!-- ===== Auth Views ===== -->
  <main class="mx-auto max-w-6xl p-4 space-y-6">
    <!-- Auth Card -->
    <section id="authView" class="glass rounded-2xl p-6 bg-white/70 dark:bg-black/50">
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <h2 class="text-lg font-semibold mb-3">ƒêƒÉng nh·∫≠p</h2>
          <form id="loginForm" class="space-y-3">
            <input id="loginEmail" class="w-full px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10" placeholder="Email" type="email" required>
            <input id="loginPassword" class="w-full px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10" placeholder="M·∫≠t kh·∫©u" type="password" required>
            <button class="w-full py-2 rounded-xl bg-indigo-600 text-white">ƒêƒÉng nh·∫≠p</button>
            <button id="forgotBtn" type="button" class="w-full py-2 rounded-xl bg-black/70 text-white">Qu√™n m·∫≠t kh·∫©u</button>
          </form>
        </div>
        <div>
          <h2 class="text-lg font-semibold mb-3">ƒêƒÉng k√Ω</h2>
          <form id="registerForm" class="space-y-3">
            <input id="regDisplayName" class="w-full px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10" placeholder="T√™n t√†i kho·∫£n" required>
            <input id="regEmail" class="w-full px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10" placeholder="Email" type="email" required>
            <input id="regPassword" class="w-full px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10" placeholder="M·∫≠t kh·∫©u" type="password" required>
            <button class="w-full py-2 rounded-xl bg-emerald-600 text-white">T·∫°o t√†i kho·∫£n</button>
          </form>
        </div>
      </div>

      <!-- Code 2: Music select -->
      <div class="mt-6 music-btn">
        <select onchange="changeSong(this.value)" class="px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10">
          <option value="">Play Music</option>
          <option value="./deanhluongthien.mp3">ƒê·ªÉ Anh L∆∞∆°ng Thi·ªán Remix</option>
          <option value="./emcuoiroia.mp3">Em C∆∞·ªõi R·ªìi √Ä Remix</option>
          <option value="./freemanxlowremix.mp3">Free Man x Low Remix</option>
          <option value="./slayphonk.mp3">Slay Phonk</option>
          <option value="./Nk.mp3">Y√™u em r·∫•t nhi·ªÅu</option>
          <option value="./nghebaitrinhchua.mp3">Nghe B√†i Tr√¨nh Ch∆∞a ??</option>
          <option value="./Quangay.mp3">T·∫°i sao Qu√¢n l√† gay ?</option>
          <option value="./B4BxAdamn.mp3">Mashup Band 4 Band x Adamn</option>
          <option value="./thaproitudo.mp3">Th√°p R∆°i T·ª± Do</option>
        </select>
        <audio id="bgMusic" autoplay loop hidden></audio>
      </div>
    </section>

    <!-- ===== Main App (hidden until login) ===== -->
    <section id="appView" class="hidden space-y-6">

      <!-- Profile + Actions -->
      <div class="glass rounded-2xl p-4 bg-white/70 dark:bg-black/50 flex items-center gap-4">
        <label class="relative inline-block">
          <img id="avatarImg" src="https://api.dicebear.com/9.x/thumbs/svg?seed=dojo" class="w-16 h-16 rounded-2xl object-cover" alt="avatar"/>
          <input id="avatarInput" type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" title="ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán"/>
        </label>
        <div class="flex-1">
          <div class="font-semibold" id="meName">‚Äî</div>
          <div class="text-sm opacity-80" id="meEmail">‚Äî</div>
          <div class="text-sm opacity-80">Follower: <span id="meFollower">0</span> <span id="followerBadge"></span></div>
        </div>
        <div class="flex items-center gap-2">
          <input id="searchUser" placeholder="T√¨m ng∆∞·ªùi d√πng‚Ä¶" class="px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10"/>
          <button id="openDM" class="px-3 py-2 rounded-xl bg-indigo-600 text-white">Nh·∫Øn tin</button>
        </div>
      </div>

      <!-- Composer -->
      <div class="glass rounded-2xl p-4 bg-white/70 dark:bg-black/50">
        <h3 class="font-semibold mb-3">ƒêƒÉng b√†i</h3>
        <form id="postForm" class="space-y-3">
          <textarea id="postText" class="w-full px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10" rows="3" placeholder="B·∫°n ƒëang nghƒ© g√¨?" required></textarea>
          <div class="flex items-center gap-3">
            <input id="postFile" type="file" class="file:mr-3 file:px-3 file:py-2 file:rounded-xl file:border-0 file:bg-indigo-600 file:text-white"/>
            <button class="px-4 py-2 rounded-xl bg-emerald-600 text-white">ƒêƒÉng</button>
            <span class="text-sm opacity-80" id="limitHint"></span>
          </div>
        </form>
      </div>

      <!-- Feed -->
      <div class="glass rounded-2xl p-4 bg-white/70 dark:bg-black/50">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">B√†i vi·∫øt m·ªõi</h3>
          <div class="text-sm opacity-75">Vu·ªët ‚ü∑ ƒë·ªÉ xem</div>
        </div>
        <div id="feed" class="post-grid flex gap-4 overflow-x-auto pb-4"></div>
      </div>

      <!-- DM drawer -->
      <div id="dmPanel" class="hidden glass rounded-2xl p-4 bg-white/70 dark:bg-black/50">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">Tin nh·∫Øn</h3>
          <button id="closeDM" class="px-3 py-1.5 rounded-xl bg-black/70 text-white">ƒê√≥ng</button>
        </div>
        <div class="grid md:grid-cols-3 gap-4">
          <div class="md:col-span-1 space-y-2" id="dmUsers"></div>
          <div class="md:col-span-2">
            <div id="dmThread" class="h-80 overflow-y-auto p-3 rounded-xl bg-black/5 dark:bg-white/5"></div>
            <form id="dmForm" class="mt-3 flex gap-2">
              <input id="dmInput" class="flex-1 px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10" placeholder="Nh·∫≠p tin nh·∫Øn‚Ä¶"/>
              <button class="px-4 py-2 rounded-xl bg-indigo-600 text-white">G·ª≠i</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Admin Vault (kho l∆∞u tr·ªØ) -->
      <div id="adminVault" class="admin-only glass rounded-2xl p-4 bg-white/70 dark:bg-black/50">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">Kho l∆∞u tr·ªØ d·ªØ li·ªáu (Admin)</h3>
          <button id="deleteAllPosts" class="px-3 py-2 rounded-xl bg-red-600 text-white">Xo√° T·∫§T C·∫¢ b√†i vi·∫øt</button>
        </div>
        <div class="flex items-center gap-2 mb-3">
          <input type="file" id="vaultFile" class="file:mr-3 file:px-3 file:py-2 file:rounded-xl file:border-0 file:bg-indigo-600 file:text-white"/>
          <button id="uploadVault" class="px-3 py-2 rounded-xl bg-indigo-600 text-white">T·∫£i l√™n kho</button>
          <button id="refreshVault" class="px-3 py-2 rounded-xl bg-black/70 text-white">L√†m m·ªõi</button>
        </div>
        <ul id="vaultList" class="text-sm space-y-1"></ul>
      </div>

    </section>
  </main>

  <!-- ===== Templates ===== -->
  <template id="postTpl">
    <article class="relative post-card min-w-[320px] max-w-[480px] w-[90vw] rounded-2xl p-4 bg-[var(--card)] dark:bg-[var(--cardDark)] glass">
      <header class="flex items-center gap-3">
        <img class="w-12 h-12 rounded-xl object-cover author-avatar"/>
        <div class="flex-1 min-w-0">
          <div class="font-semibold flex items-center gap-1">
            <span class="author-name truncate"></span>
            <span class="follow-badge"></span>
          </div>
          <div class="text-xs opacity-70"><span class="ts"></span> ‚Ä¢ <span class="views"></span> <span class="hot"></span></div>
        </div>
        <div class="flex items-center gap-2">
          <button class="followBtn px-2 py-1 rounded-lg bg-black/70 text-white text-xs">Follow</button>
          <button class="delBtn px-2 py-1 rounded-lg bg-red-600 text-white text-xs">Xo√°</button>
        </div>
      </header>
      <div class="mt-3 text-sm content"></div>
      <img class="mt-3 rounded-xl media hidden"/>
      <div class="mt-3 flex items-center gap-2">
        <input class="commentInput flex-1 px-3 py-2 rounded-xl bg-white/70 dark:bg-white/10" placeholder="B√¨nh lu·∫≠n‚Ä¶"/>
        <button class="commentBtn px-3 py-2 rounded-xl bg-indigo-600 text-white">G·ª≠i</button>
      </div>
      <div class="comment-stream mt-3 rounded-xl bg-black/5 dark:bg-white/5 p-2 space-y-1"></div>
      <div class="emoji-bubble"><div class="px-3 py-2 rounded-xl bg-black/70 text-white text-xl select-none">üòÄ üòç üëç üî• üòÜ üòÆ üò¢ üò°</div></div>
      <div class="mt-2 text-sm opacity-80">Reacts: <span class="reacts"></span></div>
    </article>
  </template>

  <!-- ===== Firebase SDKs (v12) ===== -->
  <script type="module">
    // ==== Firebase config c·ªßa b·∫°n (ƒë√É cung c·∫•p) ====
    const firebaseConfig = {
      apiKey: "AIzaSyBsLXs9rZROGQJjIYxGommG00Jf4Xxs2w0",
      authDomain: "hust-3d8f5.firebaseapp.com",
      projectId: "hust-3d8f5",
      storageBucket: "hust-3d8f5.firebasestorage.app",
      messagingSenderId: "208271977864",
      appId: "1:208271977864:web:62ddf6649d8fe16019de3d",
      measurementId: "G-XZGDGMSG97"
    };

    // ===== INIT Firebase =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, createUserWithEmailAndPassword, updateProfile, signInWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, deleteDoc, limit, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";
    import { getDatabase, ref, onValue, onDisconnect, set, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const rtdb = getDatabase(app);
    await setPersistence(auth, browserLocalPersistence); //  kh√¥ng ƒëƒÉng xu·∫•t khi t·∫£i l·∫°i trang

    // ====== C·∫•u h√¨nh admin theo email (THAY email c·ªßa b·∫°n ·ªü ƒë√¢y) ======
    const ADMIN_EMAILS = [
      'admin@yourdomain.com', // ‚Üê thay b·∫±ng email admin c·ªßa b·∫°n
    ];

    // ===== Helpers =====
    const $ = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>[...p.querySelectorAll(s)];
    const fmt = ts=> new Date(ts?.seconds? ts.seconds*1000: ts).toLocaleString('vi-VN');

    // ===== Theme toggle =====
    const themeToggle = $('#themeToggle');
    document.documentElement.classList.toggle('dark', localStorage.getItem('theme')==='dark');
    themeToggle.addEventListener('click',()=>{
      const d = !document.documentElement.classList.contains('dark');
      document.documentElement.classList.toggle('dark', d);
      localStorage.setItem('theme', d? 'dark':'light');
    });

    // ===== Background toggle =====
    const bgToggle = $('#bgToggle');
    const bgVideo = $('#bgVideo');
    const bgOverlay = $('#bgOverlay');
    bgToggle.addEventListener('click', ()=>{
      const off = !bgVideo.paused;
      if(off){ bgVideo.pause(); bgOverlay.style.background='linear-gradient(180deg,rgba(0,0,0,.85),rgba(0,0,0,.85))'; bgToggle.textContent='B·∫≠t n·ªÅn'; }
      else { bgVideo.play(); bgOverlay.style.background='linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.25))'; bgToggle.textContent='T·∫Øt n·ªÅn'; }
    });

    // ===== Music (Code 2) =====
    const player = $('#bgMusic');
    window.changeSong = (src)=>{ if(!src) return; player.src = src; player.play().catch(()=>{}); };

    // ===== Auth =====
    const authView = $('#authView');
    const appView  = $('#appView');
    const logoutBtn = $('#logoutBtn');

    $('#registerForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const email = $('#regEmail').value.trim();
      const pass  = $('#regPassword').value;
      const name  = $('#regDisplayName').value.trim();
      const cr = await createUserWithEmailAndPassword(auth,email,pass);
      await updateProfile(cr.user,{ displayName:name });
      await setDoc(doc(db,'users',cr.user.uid),{ displayName:name, email, createdAt: serverTimestamp(), avatar:null, followers:0, role: ADMIN_EMAILS.includes(email)? 'admin':'user' });
    });

    $('#loginForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const email = $('#loginEmail').value.trim();
      const pass  = $('#loginPassword').value;
      const cr = await signInWithEmailAndPassword(auth,email,pass);
      // n·∫øu l√† admin m√† user doc ch∆∞a c√≥ role, g√°n role
      const uref = doc(db,'users',cr.user.uid);
      const us = await getDoc(uref);
      if(!us.exists()){
        await setDoc(uref,{ displayName: cr.user.displayName||email, email, createdAt: serverTimestamp(), avatar:null, followers:0, role: ADMIN_EMAILS.includes(email)? 'admin':'user' });
      } else if(ADMIN_EMAILS.includes(email) && (us.data().role!=='admin')){
        await updateDoc(uref,{ role:'admin' });
      }
    });

    $('#forgotBtn').addEventListener('click', async ()=>{
      const email = prompt('Nh·∫≠p email ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u');
      if(email){ await sendPasswordResetEmail(auth,email); alert('ƒê√£ g·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u'); }
    });

    logoutBtn.addEventListener('click', ()=> signOut(auth));

    // ===== Presence (online count) via RTDB =====
    const onlineCountEl = $('#onlineCount');
    let myPresenceRef;
    function setupPresence(user){
      const presenceRef = ref(rtdb, 'presence');
      myPresenceRef = ref(rtdb, `presence/${user.uid}`);
      set(myPresenceRef, { displayName: user.displayName || user.email, ts: Date.now() });
      onDisconnect(myPresenceRef).remove();
      onValue(presenceRef, snap=>{
        const data = snap.val()||{}; onlineCountEl.textContent = `${Object.keys(data).length} online`;
      });
      setInterval(()=> set(myPresenceRef, { displayName: user.displayName||user.email, ts: Date.now()}), 30000);
    }

    // ===== Random banner every 5 minutes; show 12s =====
    const badgeRandom = $('#badgeRandom');
    async function showRandomBadge(){
      const qs = await getDocs(query(collection(db,'users'), limit(50)));
      const arr = qs.docs.map(d=>({id:d.id,...d.data()}));
      if(!arr.length) return;
      const pick = arr[Math.floor(Math.random()*arr.length)];
      badgeRandom.textContent = `ID User: ${pick.id}`;
      badgeRandom.classList.remove('hidden');
      setTimeout(()=> badgeRandom.classList.add('hidden'), 12000);
    }
    setInterval(showRandomBadge, 5*60*1000);

    // ===== Profile + avatar =====
    const meName=$('#meName'), meEmail=$('#meEmail'), meFollower=$('#meFollower'), followerBadge=$('#followerBadge');
    const avatarImg=$('#avatarImg'), avatarInput=$('#avatarInput');

    avatarInput.addEventListener('change', async e=>{
      const f = e.target.files?.[0]; if(!f || !auth.currentUser) return;
      const r = sRef(storage, `avatars/${auth.currentUser.uid}`);
      await uploadBytes(r,f); const url = await getDownloadURL(r);
      await updateDoc(doc(db,'users',auth.currentUser.uid), { avatar:url });
      avatarImg.src = url;
    });

    // ===== Daily post limit =====
    async function canPost(uid, isAdmin){
      if(isAdmin) return true;
      const qs = await getDocs(query(collection(db,'posts'), where('uid','==',uid), orderBy('createdAt','desc'), limit(1)));
      if(qs.empty) return true;
      const last = qs.docs[0].data();
      const lastDate = new Date((last.createdAt?.seconds||0)*1000).toDateString();
      return lastDate !== new Date().toDateString();
    }

    // ===== Create post =====
    const postForm = $('#postForm');
    const limitHint = $('#limitHint');
    async function refreshLimitHint(){
      const user=auth.currentUser; if(!user){ limitHint.textContent=''; return; }
      const prof=await getDoc(doc(db,'users',user.uid)); const role=prof.data()?.role||'user';
      const ok = await canPost(user.uid, role==='admin');
      limitHint.textContent = ok? (role==='admin'? 'Admin: kh√¥ng gi·ªõi h·∫°n':'B·∫°n c√≤n 1 l·∫ßn ƒëƒÉng h√¥m nay'): 'ƒê√£ d√πng l∆∞·ª£t h√¥m nay';
    }

    postForm.addEventListener('submit', async e=>{
      e.preventDefault();
      const user = auth.currentUser; if(!user) return;
      const prof = await getDoc(doc(db,'users',user.uid));
      const role = prof.data()?.role || 'user';
      const allowed = await canPost(user.uid, role==='admin');
      if(!allowed){ alert('B·∫°n ch·ªâ ƒë∆∞·ª£c ƒëƒÉng 1 b√†i/ng√†y.'); return; }
      if(!confirm('X√°c nh·∫≠n ƒëƒÉng b√†i?')) return; // h·ªèi tr∆∞·ªõc khi ƒëƒÉng

      const text = $('#postText').value.trim();
      const file = $('#postFile').files?.[0];
      let mediaURL=null;
      if(file){
        const r = sRef(storage, `posts/${user.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(r, file); mediaURL = await getDownloadURL(r);
      }
      await addDoc(collection(db,'posts'),{
        uid: user.uid,
        text,
        mediaURL,
        createdAt: serverTimestamp(),
        views:0,
        reacts:{},
      });
      $('#postText').value=''; $('#postFile').value='';
      refreshLimitHint();
    });

    // ===== Feed =====
    const feed = $('#feed');
    const postTpl = $('#postTpl');

    async function isFollowing(targetUid){
      const me=auth.currentUser; if(!me) return false;
      const d=await getDoc(doc(db,'users',targetUid,'followers', me.uid));
      return d.exists();
    }

    function bindFollowButton(btn, targetUid){
      async function update(){
        btn.disabled=true;
        const yes = await isFollowing(targetUid);
        btn.textContent = yes? 'Unfollow':'Follow';
        btn.classList.toggle('bg-black/70', !yes);
        btn.classList.toggle('bg-amber-600', yes);
        btn.disabled=false;
      }
      btn.onclick = async ()=>{
        const me=auth.currentUser; if(!me||me.uid===targetUid) return;
        const fRef = doc(db,'users',targetUid,'followers', me.uid);
        const yes = await isFollowing(targetUid);
        if(yes){ await deleteDoc(fRef); } else { await setDoc(fRef,{ at: serverTimestamp() }); }
        const followersSnap = await getDocs(collection(db,'users',targetUid,'followers'));
        await updateDoc(doc(db,'users',targetUid),{ followers: followersSnap.size });
        update();
      };
      update();
    }

    function renderPost(id, data, me){
      let card = $(`[data-id="${id}"]`, feed);
      if(!card){
        card = postTpl.content.firstElementChild.cloneNode(true);
        card.dataset.id = id;
        feed.appendChild(card);
        // Long-press emoji
        let pressTimer; const bubble = $('.emoji-bubble', card);
        card.addEventListener('touchstart', ()=>{ pressTimer=setTimeout(()=>{bubble.style.display='block'},450)}, {passive:true});
        card.addEventListener('touchend', ()=>{ clearTimeout(pressTimer); setTimeout(()=> bubble.style.display='none', 800) }, {passive:true});
        card.addEventListener('mousedown', ()=>{ pressTimer=setTimeout(()=>{bubble.style.display='block'},500)});
        card.addEventListener('mouseup', ()=>{ clearTimeout(pressTimer); setTimeout(()=> bubble.style.display='none', 800) });
        bubble.addEventListener('click', e=>{
          if(e.target.textContent.trim()) reactToPost(id, e.target.textContent.trim());
        });
        $('.commentBtn', card).addEventListener('click', ()=> doComment(id, $('.commentInput',card).value, card));
        $('.delBtn', card).addEventListener('click', ()=> deletePost(id, data.uid));
      }
      // author
      getDoc(doc(db,'users',data.uid)).then(u=>{
        const ud=u.data()||{};
        $('.author-name',card).textContent = ud.displayName||'·∫®n danh';
        $('.author-avatar',card).src = ud.avatar || `https://api.dicebear.com/9.x/thumbs/svg?seed=${data.uid.slice(0,6)}`;
        const badge = $('.follow-badge',card);
        if((ud.followers||0) >= 5) { badge.textContent='üíé' } else { badge.textContent=''; }
      });
      // follow button state
      bindFollowButton($('.followBtn',card), data.uid);

      // content
      $('.content',card).textContent = data.text||'';
      const media = $('.media',card);
      if(data.mediaURL){ media.src=data.mediaURL; media.classList.remove('hidden'); }
      else media.classList.add('hidden');
      $('.ts',card).textContent = fmt(data.createdAt);
      $('.views',card).textContent = `${data.views||0} l∆∞·ª£t xem`;
      $('.hot',card).textContent = (data.views||0) >= 10 ? 'üî•' : '';
      const reacts = data.reacts||{}; $('.reacts',card).textContent = Object.entries(reacts).map(([k,v])=>`${k} ${v}`).join(' ¬∑ ');

      // comments stream
      const cWrap = $('.comment-stream',card);
      onSnapshot(query(collection(db,'posts',id,'comments'), orderBy('createdAt','desc'), limit(30)), snap=>{
        cWrap.innerHTML='';
        snap.forEach(d=>{
          const c=d.data();
          const el=document.createElement('div');
          el.className='text-sm';
          el.textContent=`${c.byName||'·∫®n danh'}: ${c.text}`;
          cWrap.prepend(el);
        });
        cWrap.scrollTop = cWrap.scrollHeight; // tr√¥i khi c√≥ m·ªõi
      });

      // view counting once per session per post
      if(me){
        const key = 'viewed_'+id; if(!sessionStorage.getItem(key)){
          sessionStorage.setItem(key,'1');
          updateDoc(doc(db,'posts',id),{ views:(data.views||0)+1 });
        }
      }
    }

    async function reactToPost(id, emoji){
      const postRef = doc(db,'posts',id);
      const snap = await getDoc(postRef); const data = snap.data()||{}; const reacts=data.reacts||{};
      reacts[emoji] = (reacts[emoji]||0) + 1;
      await updateDoc(postRef,{ reacts });
    }

    async function doComment(id, text, card){
      text = (text||'').trim(); if(!text) return; $('.commentInput',card).value='';
      const user = auth.currentUser; if(!user) return;
      const meDoc = await getDoc(doc(db,'users',user.uid));
      await addDoc(collection(db,'posts',id,'comments'),{ text, by:user.uid, byName: meDoc.data()?.displayName||user.email, createdAt: serverTimestamp() });
    }

    async function deletePost(id, ownerUid){
      const me = auth.currentUser; if(!me) return;
      const meRole = (await getDoc(doc(db,'users',me.uid))).data()?.role||'user';
      if(meRole!=='admin' && me.uid!==ownerUid){ return alert('B·∫°n kh√¥ng c√≥ quy·ªÅn xo√° b√†i n√†y.'); }
      if(confirm('Xo√° b√†i vi·∫øt?')) await deleteDoc(doc(db,'posts',id));
    }

    // ===== Feed live query =====
    onSnapshot(query(collection(db,'posts'), orderBy('createdAt','desc'), limit(50)), snap=>{
      const me = auth.currentUser;
      snap.docChanges().forEach(ch=>{
        if(ch.type==='removed'){ const el=$(`[data-id="${ch.doc.id}"]`,feed); if(el) el.remove(); }
        else renderPost(ch.doc.id, ch.doc.data(), !!me);
      });
    });

    // ===== DM =====
    const dmPanel=$('#dmPanel'), openDM=$('#openDM'), closeDM=$('#closeDM'), dmUsers=$('#dmUsers'), dmThread=$('#dmThread');
    let currentDM=null;

    openDM.addEventListener('click', ()=> dmPanel.classList.remove('hidden'));
    closeDM.addEventListener('click', ()=> dmPanel.classList.add('hidden'));

    function chatId(a,b){ return [a,b].sort().join('_'); }

    $('#dmForm').addEventListener('submit', async e=>{
      e.preventDefault(); if(!currentDM||!auth.currentUser) return; const t=$('#dmInput').value.trim(); if(!t) return; $('#dmInput').value='';
      const cid=chatId(auth.currentUser.uid,currentDM);
      await addDoc(collection(db,'chats',cid,'msgs'), { text:t, by:auth.currentUser.uid, at: serverTimestamp() });
    });

    async function loadThread(){
      if(!currentDM || !auth.currentUser) return;
      const cid = chatId(auth.currentUser.uid, currentDM);
      onSnapshot(query(collection(db,'chats',cid,'msgs'), orderBy('at','asc'), limit(200)), snap=>{
        dmThread.innerHTML='';
        snap.forEach(m=>{
          const d=m.data(); const mine = d.by===auth.currentUser.uid;
          const row=document.createElement('div');
          row.className=`mb-2 flex ${mine? 'justify-end':''}`;
          row.innerHTML=`<div class="max-w-[70%] px-3 py-2 rounded-xl ${mine? 'bg-indigo-600 text-white':'bg-black/10 dark:bg-white/10'}">${d.text}</div>`;
          dmThread.appendChild(row);
        });
        dmThread.scrollTop=dmThread.scrollHeight;
      });
    }

    onAuthStateChanged(auth, async user=>{
      if(user){
        authView.classList.add('hidden'); appView.classList.remove('hidden'); logoutBtn.classList.remove('hidden');
        setupPresence(user); showRandomBadge(); refreshLimitHint();
        const u = await getDoc(doc(db,'users',user.uid));
        const d = u.data()||{}; $('#meName').textContent=d.displayName||user.email; $('#meEmail').textContent=user.email; $('#meFollower').textContent = d.followers||0; $('#followerBadge').textContent = (d.followers||0)>=5 ? 'üíé':'';
        if(d.avatar) $('#avatarImg').src=d.avatar;

        // list users for DM
        onSnapshot(query(collection(db,'users'), limit(50)), snap=>{
          dmUsers.innerHTML='';
          snap.forEach(x=>{
            if(x.id===user.uid) return;
            const btn=document.createElement('button');
            btn.className='w-full px-3 py-2 rounded-xl bg-black/70 text-white text-left';
            btn.textContent=(x.data().displayName||x.data().email||'User')+` ‚Äî ${x.id.slice(0,6)}`;
            btn.onclick=()=>{ currentDM=x.id; loadThread(); };
            dmUsers.appendChild(btn);
          });
        });

        // ADMIN enable
        const role = d.role||'user';
        if(role==='admin'){ $('#adminVault').classList.remove('admin-only'); }

      } else {
        authView.classList.remove('hidden'); appView.classList.add('hidden'); logoutBtn.classList.add('hidden');
      }
    });

    // ===== Search user (quick follow) =====
    $('#searchUser').addEventListener('keydown', async e=>{
      if(e.key!=='Enter') return; e.preventDefault(); const q=e.target.value.trim(); if(!q) return;
      const res = await getDocs(query(collection(db,'users'), where('displayName','==',q)));
      if(res.empty) return alert('Kh√¥ng t√¨m th·∫•y');
      const t=res.docs[0]; if(confirm(`Follow ${t.data().displayName}?`)){
        const me=auth.currentUser; if(!me) return; const fRef = doc(db,'users',t.id,'followers', me.uid);
        await setDoc(fRef,{ at: serverTimestamp() });
        const followersSnap = await getDocs(collection(db,'users',t.id,'followers'));
        await updateDoc(doc(db,'users',t.id),{ followers: followersSnap.size });
      }
    });

    // ===== Admin actions =====
    $('#deleteAllPosts').addEventListener('click', async ()=>{
      const me=auth.currentUser; if(!me) return; const role=(await getDoc(doc(db,'users',me.uid))).data()?.role||'user';
      if(role!=='admin') return alert('Ch·ªâ admin');
      if(!confirm('X√°c nh·∫≠n xo√° T·∫§T C·∫¢ b√†i vi·∫øt?')) return;
      const qs=await getDocs(query(collection(db,'posts'), limit(200)));
      const batch=writeBatch(db); qs.docs.forEach(d=> batch.delete(doc(db,'posts',d.id))); await batch.commit();
      alert('ƒê√£ xo√°.');
    });

    async function refreshVaultList(){
      const me=auth.currentUser; if(!me) return; const role=(await getDoc(doc(db,'users',me.uid))).data()?.role||'user';
      if(role!=='admin') return;
      const ul=$('#vaultList'); ul.innerHTML='';
      const folder=sRef(storage,'vault/');
      const items = await listAll(folder);
      for(const it of items.items){
        const url=await getDownloadURL(it);
        const li=document.createElement('li');
        li.innerHTML=`<a class="underline" href="${url}" target="_blank">${it.name}</a>`;
        ul.appendChild(li);
      }
    }

    $('#uploadVault').addEventListener('click', async ()=>{
      const f=$('#vaultFile').files?.[0]; if(!f) return; const me=auth.currentUser; const role=(await getDoc(doc(db,'users',me.uid))).data()?.role||'user'; if(role!=='admin') return alert('Ch·ªâ admin');
      const r=sRef(storage, `vault/${Date.now()}_${f.name}`); await uploadBytes(r,f); await refreshVaultList();
    });
    $('#refreshVault').addEventListener('click', refreshVaultList);

  </script>
</body>
</html>
