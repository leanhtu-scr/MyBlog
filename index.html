<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Social ‚Äî Firestore (ƒê√£ ch√®n config)</title>
<style>
  :root{--bg:#000;--text:#fff;--muted:rgba(255,255,255,.66);--card:rgba(255,255,255,.04);--accent:#ff3b30}
  [data-theme="light"]{--bg:#f6f6f7;--text:#111;--muted:rgba(0,0,0,.6);--card:rgba(0,0,0,.04)}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #bgVideo{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;filter:brightness(.28)}
  header{position:relative;z-index:12;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  .brand{font-weight:800;color:var(--accent)}
  .app{position:relative;z-index:10;max-width:980px;margin:8px auto;padding:8px}
  .card{background:var(--card);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.06)}
  .row{display:flex;gap:10px;align-items:center}
  input,textarea,select,button{font-family:inherit}
  input,textarea,select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
  textarea{min-height:90px}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;color:var(--text);cursor:pointer}
  .stage{display:flex;gap:16px;align-items:flex-start}
  .left{flex:1}
  .right{width:320px}
  #feed{max-height:70vh;overflow:hidden;padding:8px}
  .post{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;margin-bottom:12px;transition:transform .12s}
  .post:hover{transform:translateY(-4px)}
  .meta{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}
  .author{display:flex;align-items:center;gap:8px}
  .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.06)}
  .reactions{display:flex;gap:8px;margin-top:8px}
  .reaction{padding:6px 9px;border-radius:12px;background:rgba(255,255,255,0.03);cursor:pointer;border:1px solid rgba(255,255,255,0.03);display:inline-flex;align-items:center;gap:6px}
  .reaction.selected{border-color:var(--accent);box-shadow:0 8px 24px rgba(0,0,0,0.35);transform:scale(1.06)}
  .comments{max-height:140px;overflow:hidden;margin-top:8px}
  .comment-list{display:flex;flex-direction:column-reverse;gap:6px;overflow-y:auto;padding:6px}
  .comment{display:flex;gap:8px;align-items:flex-start;background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;opacity:0;transform:translateY(10px);animation:slideUp .28s forwards}
  .comment .c-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover}
  @keyframes slideUp{to{opacity:1;transform:none}}
  .fadeOut{animation:fadeOut 1s forwards}
  @keyframes fadeOut{to{opacity:0;height:0;margin:0;padding:0}}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:60}
  .modal .box{width:92%;max-width:720px;background:var(--card);padding:14px;border-radius:12px}
  .music-fixed{position:fixed;left:12px;bottom:12px;z-index:40;background:rgba(0,0,0,0.5);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06)}
  .music-fixed select{min-width:200px}
  .tiny{font-size:12px;color:var(--muted)}
  .views{margin-left:8px}
  @media(max-width:900px){ .stage{flex-direction:column} .right{width:100%} .music-fixed select{min-width:140px} }
</style>
</head>
<body data-theme="">

<!-- Background video (put background.mp4 in same folder) -->
<video id="bgVideo" autoplay muted loop playsinline>
  <source src="background.mp4" type="video/mp4" />
</video>

<header>
  <div class="brand">Mini Social ‚Äî Firestore</div>
  <div style="display:flex;gap:8px;align-items:center">
    <button id="themeToggle" class="btn tiny">Theme</button>
    <button id="btnLogout" class="btn tiny" style="display:none">ƒêƒÉng xu·∫•t</button>
  </div>
</header>

<div class="app">
  <div class="card stage">
    <div class="left">
      <!-- composer -->
      <div id="composer" class="card" style="display:none">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="authorName" placeholder="T√™n t√†i kho·∫£n (hi·ªÉn th·ªã)" style="flex:1" />
          <input id="avatarFile" type="file" accept="image/*" class="tiny" />
        </div>
        <textarea id="postContent" placeholder="Vi·∫øt b√†i... (admin kh√¥ng gi·ªõi h·∫°n, user 1 b√†i/ng√†y)"></textarea>
        <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
          <button id="btnPost" class="btn">ƒêƒÉng</button>
          <button id="btnDelete" class="btn">X√≥a b√†i hi·ªán t·∫°i</button>
          <div style="margin-left:auto" id="whoInfo" class="tiny"></div>
        </div>
      </div>

      <!-- feed -->
      <div id="feed" class="card" style="margin-top:12px">
        <div id="emptyHint" class="tiny" style="text-align:center;padding:30px;color:var(--muted)">Ch∆∞a c√≥ b√†i vi·∫øt ‚Äî ƒëƒÉng b√†i ƒë·∫ßu ti√™n nh√©!</div>
        <!-- posts injected here -->
      </div>
    </div>

    <aside class="right">
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Auth</div>
        <div id="authBox">
          <div id="registerPanel">
            <input id="regUser" placeholder="T√™n t√†i kho·∫£n (login)" />
            <input id="regPass" type="password" placeholder="M·∫≠t kh·∫©u" />
            <input id="regAvatarUrl" placeholder="Avatar URL (t√πy ch·ªçn)" />
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="btnRegister" class="btn">ƒêƒÉng k√Ω</button>
              <button id="btnShowLogin" class="btn">ƒêƒÉng nh·∫≠p</button>
            </div>
          </div>

          <div id="loginPanel" style="display:none">
            <input id="loginUser" placeholder="T√™n t√†i kho·∫£n (login)"/>
            <input id="loginPass" type="password" placeholder="M·∫≠t kh·∫©u" />
            <input id="loginAvatarUrl" placeholder="C·∫≠p nh·∫≠t Avatar URL (t√πy ch·ªçn)" />
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="btnLogin" class="btn">ƒêƒÉng nh·∫≠p</button>
              <button id="btnShowReg" class="btn">ƒêƒÉng k√Ω</button>
            </div>
            <div style="margin-top:8px">
              <input id="fpUser" placeholder="T√™n t√†i kho·∫£n ƒë·ªÉ reset m·∫≠t kh·∫©u" />
              <button id="btnForgot" class="btn tiny">Qu√™n m·∫≠t kh·∫©u (m√£=0)</button>
            </div>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Music</div>
        <div class="music-fixed">
          <div style="display:flex;gap:8px;align-items:center">
            <select id="musicList"></select>
            <button id="musicPlay" class="btn">‚èØ</button>
          </div>
          <div style="margin-top:8px" class="tiny">B·∫°n c√≥ th·ªÉ add URL mp3</div>
          <div style="margin-top:6px;display:flex;gap:8px">
            <button id="btnAddMusic" class="btn tiny">+Add</button>
            <button id="btnPrev" class="btn tiny">Prev</button>
            <button id="btnNext" class="btn tiny">Next</button>
          </div>
          <audio id="bgMusic" loop></audio>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- modal detail -->
<div id="modal" class="modal"><div class="box card" id="modalBox"></div></div>

<!-- toast -->
<div id="toastRoot"></div>

<!-- Firebase + app code -->
<script type="module">
/* ========== FIREBASE CONFIG (ƒë√£ ch√®n) ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy,
  doc, getDoc, updateDoc, arrayUnion, arrayRemove, increment, runTransaction,
  deleteDoc, where, getDocs, limit
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBTcjWMAWAd6t3fPOi7jGFjMW3PHdZBfg",
  authDomain: "myblog-2d856.firebaseapp.com",
  projectId: "myblog-2d856",
  storageBucket: "myblog-2d856.appspot.com",
  messagingSenderId: "784534821820",
  appId: "1:784534821820:web:c1f8271825c192a93f3890",
  measurementId: "G-RRFMNJLZTT"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ========== HELPERS & STATE ========== */
const $ = s => document.querySelector(s);
const uid = ()=> localStorage.getItem('ms_uid') || (function(){ const id = 'u_'+Math.random().toString(36).slice(2,10); localStorage.setItem('ms_uid', id); return id })();
const toast = (t,ms=2200)=>{ const d=document.createElement('div'); d.className='toast'; d.innerText=t; d.style.position='fixed'; d.style.left='50%'; d.style.transform='translateX(-50%)'; d.style.bottom='20px'; d.style.zIndex=70; d.style.padding='10px 14px'; d.style.borderRadius='10px'; d.style.background='#111'; document.body.appendChild(d); setTimeout(()=>d.remove(),ms); }
function now(){ return Date.now(); }

let currentUser = null;
let posts = [];
let musicList = [
  { url:'./deanhluongthien.mp3', title:'ƒê·ªÉ Anh L∆∞∆°ng Thi·ªán Remix' },
  { url:'./emcuoiroia.mp3', title:'Em C∆∞·ªõi R·ªìi √Ä Remix' },
  { url:'./freemanxlowremix.mp3', title:'Free Man x Low Remix' },
];

/* UI refs */
const composer = $('#composer'), whoInfo = $('#whoInfo'), feed = $('#feed'), emptyHint = $('#emptyHint');
const btnRegister = $('#btnRegister'), btnShowLogin = $('#btnShowLogin'), btnShowReg = $('#btnShowReg');
const btnLogin = $('#btnLogin'), btnLogout = $('#btnLogout'), btnForgot = $('#btnForgot');
const btnPost = $('#btnPost'), btnDelete = $('#btnDelete');
const regUser = $('#regUser'), regPass = $('#regPass'), regAvatarUrl = $('#regAvatarUrl');
const loginUser = $('#loginUser'), loginPass = $('#loginPass'), loginAvatarUrl = $('#loginAvatarUrl');
const fpUser = $('#fpUser');
const authorName = $('#authorName'), avatarFile = $('#avatarFile'), postContent = $('#postContent');
const musicSelect = $('#musicList'), bgMusic = $('#bgMusic'), musicPlay = $('#musicPlay'), btnAddMusic = $('#btnAddMusic'), btnPrev = $('#btnPrev'), btnNext = $('#btnNext');
const modal = $('#modal'), modalBox = $('#modalBox');
const themeToggle = $('#themeToggle');

/* ---------- REALTIME POSTS ---------- */
function startRealtime(){
  const q = query(collection(db,'posts'), orderBy('timestamp','desc'));
  onSnapshot(q, snap=>{
    posts = [];
    snap.forEach(d => posts.push({ id: d.id, ...d.data() }));
    renderFeed();
  });
}

/* ---------- RENDER ---------- */
function renderFeed(){
  feed.innerHTML = '';
  if(posts.length === 0){ emptyHint.style.display = 'block'; return; } else emptyHint.style.display='none';
  posts.forEach(p => { const node = createPostNode(p); feed.appendChild(node); });
}

function createPostNode(p){
  const n = document.createElement('div'); n.className='post'; n.dataset.id = p.id;
  const header = document.createElement('div'); header.className='meta';
  const left = document.createElement('div'); left.className='author';
  const img = document.createElement('img'); img.className='avatar';
  img.src = (p.authorAvatar || p.authorAvatarUrl) || defaultAvatarSVG();
  img.onerror = ()=>{ img.src = defaultAvatarSVG(); };
  const nameSpan = document.createElement('span'); nameSpan.textContent = p.username || p.author || '·∫®n danh';
  if((p.views||0) >= 10){ const f = document.createElement('span'); f.textContent = ' üî•'; nameSpan.appendChild(f); }
  left.appendChild(img); left.appendChild(nameSpan);
  header.appendChild(left);
  const right = document.createElement('div'); right.className='tiny';
  const time = document.createElement('div'); time.textContent = p.timestamp ? new Date(p.timestamp.seconds ? p.timestamp.toMillis() : p.timestamp).toLocaleString() : '';
  const views = document.createElement('div'); views.className='tiny views'; views.textContent = `üëÅ ${p.views||0}`;
  right.appendChild(time); right.appendChild(views);
  header.appendChild(right);
  n.appendChild(header);

  const content = document.createElement('div'); content.style.marginTop='8px';
  content.innerHTML = `<div style="white-space:pre-wrap;cursor:pointer" class="postText">${escapeHtml(p.content||'')}</div>`;
  content.querySelector('.postText').addEventListener('click', ()=> openPostDetail(p.id));
  n.appendChild(content);

  if(p.imageURL){ const im = document.createElement('img'); im.src=p.imageURL; im.style.maxWidth='100%'; im.style.marginTop='8px'; n.appendChild(im); }

  const emojis = ['‚ù§Ô∏è','üòÇ','üî•','üëç','üòÆ','üéâ'];
  const rwrap = document.createElement('div'); rwrap.className='reactions';
  emojis.forEach(e=>{
    const btn = document.createElement('div'); btn.className='reaction'; btn.dataset.emoji = e;
    const spanE = document.createElement('span'); spanE.textContent = e;
    const spanCount = document.createElement('span'); spanCount.className='count tiny'; spanCount.style.marginLeft='6px';
    spanCount.textContent = p.reactions && p.reactions[e] ? p.reactions[e] : 0;
    btn.appendChild(spanE); btn.appendChild(spanCount);
    if(currentUser && p.userReactions && p.userReactions[currentUser.name] === e) btn.classList.add('selected');
    btn.addEventListener('click', ()=> onReactClick(p.id, e, btn, spanCount));
    rwrap.appendChild(btn);
  });
  n.appendChild(rwrap);

  const cwrap = document.createElement('div'); cwrap.className='comments';
  const clist = document.createElement('div'); clist.className='comment-list'; clist.id = 'c'+p.id;
  (p.comments || []).forEach(cmt => appendCommentDom(clist, cmt.user, cmt.text, cmt.ts, cmt.avatar));
  cwrap.appendChild(clist);
  n.appendChild(cwrap);

  const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginTop='8px';
  const input = document.createElement('input'); input.className='input'; input.placeholder='B√¨nh lu·∫≠n...'; input.style.flex='1';
  input.id = 'in'+p.id;
  const send = document.createElement('button'); send.className='btn'; send.textContent='G·ª≠i';
  send.addEventListener('click', ()=> handleSendComment(p.id));
  const del = document.createElement('button'); del.className='btn'; del.textContent='X√≥a'; del.addEventListener('click', ()=> deletePost(p.id));
  row.appendChild(input); row.appendChild(send); row.appendChild(del);
  n.appendChild(row);

  return n;
}

function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function defaultAvatarSVG(){ const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'><rect width='100%' height='100%' fill='#777'/></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }

/* ---------- open detail & increment view ---------- */
async function openPostDetail(postId){
  const docRef = doc(db,'posts',postId);
  try{
    await runTransaction(db, async (tx)=>{
      const docSnap = await tx.get(docRef);
      if(!docSnap.exists()) throw "Not exist";
      const data = docSnap.data();
      const viewers = data.viewers || [];
      const userKey = currentUser ? currentUser.name : uid();
      if(!viewers.includes(userKey)){
        tx.update(docRef, { views: (data.views||0)+1, viewers: arrayUnion(userKey) });
      }
    });
  }catch(e){ console.warn('Transaction error view:', e); }
  const p = posts.find(x=>x.id===postId);
  if(!p) return;
  modalBox.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px">
      <img src="${p.authorAvatar || p.authorAvatarUrl || defaultAvatarSVG()}" style="width:56px;height:56px;border-radius:50%;object-fit:cover" />
      <div>
        <div style="font-weight:700">${escapeHtml(p.username||p.author||'·∫®n danh')} ${ (p.views||0)>=10 ? 'üî•' : '' }</div>
        <div class="tiny">${p.timestamp ? (new Date(p.timestamp.seconds ? p.timestamp.toMillis() : p.timestamp)).toLocaleString() : ''} ¬∑ üëÅ ${p.views||0}</div>
      </div>
    </div>
    <div style="margin-top:12px;white-space:pre-wrap">${escapeHtml(p.content||'')}</div>
    ${p.imageURL ? `<img src="${p.imageURL}" style="width:100%;margin-top:12px" />` : ''}
    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="modalClose" class="btn">ƒê√≥ng</button>
    </div>
    <div style="margin-top:12px"><strong>B√¨nh lu·∫≠n:</strong></div>
    <div id="modalComments" style="max-height:240px;overflow:auto;margin-top:6px"></div>
  `;
  const mc = $('#modalComments');
  (p.comments || []).slice().reverse().forEach(c=>{ const div = document.createElement('div'); div.className='card tiny'; div.style.marginBottom='6px'; div.style.padding='8px'; div.innerText = `${c.user}: ${c.text}`; mc.appendChild(div); });
  modal.style.display='flex';
  $('#modalClose').onclick = ()=> modal.style.display='none';
}

/* ---------- reaction (transaction) ---------- */
async function onReactClick(postId, emoji, btn, countSpan){
  if(!currentUser) return toast('ƒêƒÉng nh·∫≠p ƒë·ªÉ ph·∫£n ·ª©ng');
  const postRef = doc(db,'posts',postId);
  const me = currentUser.name;
  try{
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(postRef);
      if(!snap.exists()) throw "No doc";
      const data = snap.data();
      data.reactions = data.reactions || {};
      data.userReactions = data.userReactions || {};
      const prev = data.userReactions[me] || null;
      if(prev === emoji){
        data.reactions[emoji] = Math.max(0, (data.reactions[emoji]||0) - 1);
        data.userReactions[me] = null;
      } else {
        if(prev){ data.reactions[prev] = Math.max(0,(data.reactions[prev]||0) - 1); }
        data.reactions[emoji] = (data.reactions[emoji]||0) + 1;
        data.userReactions[me] = emoji;
      }
      tx.update(postRef, { reactions: data.reactions, userReactions: data.userReactions });
    });
  }catch(e){ console.error('react err', e); toast('L·ªói khi react'); }
}

/* ---------- comments ---------- */
async function handleSendComment(postId){
  if(!currentUser) return toast('ƒêƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n');
  const inp = $('#in'+postId);
  if(!inp) return;
  const text = inp.value.trim();
  if(!text) return;
  const postRef = doc(db,'posts',postId);
  const commentObj = { user: currentUser.name, text, ts: now(), avatar: currentUser.avatarUrl || currentUser.avatarData || '' };
  try{
    await updateDoc(postRef, { comments: arrayUnion(commentObj) });
    inp.value = '';
    const list = $('#c'+postId);
    if(list) appendCommentDom(list, commentObj.user, commentObj.text, commentObj.ts, commentObj.avatar);
  }catch(e){ console.error('comment err', e); toast('L·ªói khi g·ª≠i b√¨nh lu·∫≠n'); }
}

function appendCommentDom(listEl, user, text, ts, avatar){
  const d = document.createElement('div'); d.className='comment';
  const avImg = document.createElement('img'); avImg.className='c-avatar'; avImg.src = avatar || defaultAvatarSVG(); avImg.onerror = ()=>avImg.src = defaultAvatarSVG();
  const txt = document.createElement('div'); txt.style.flex='1'; txt.innerText = `${user}: ${text}`;
  d.appendChild(avImg); d.appendChild(txt);
  listEl.insertBefore(d, listEl.firstChild);
  setTimeout(()=>{ d.classList.add('fadeOut'); setTimeout(()=>d.remove(), 1000); }, 15000);
}

/* ---------- delete post ---------- */
async function deletePost(postId){
  if(!currentUser) return toast('ƒêƒÉng nh·∫≠p ƒë·ªÉ x√≥a');
  const p = posts.find(x=>x.id===postId);
  if(!p) return;
  if(!(currentUser.isAdmin || p.username === currentUser.name)){
    return toast('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a b√†i n√†y');
  }
  if(!confirm('X√°c nh·∫≠n x√≥a b√†i?')) return;
  try{
    await deleteDoc(doc(db,'posts',postId));
    toast('ƒê√£ x√≥a b√†i');
  }catch(e){ console.error(e); toast('L·ªói x√≥a b√†i'); }
}

/* ---------- upload helper ---------- */
async function uploadFileToStorage(file, path){
  const refStore = ref(storage, path);
  await uploadBytes(refStore, file);
  return await getDownloadURL(refStore);
}

/* ---------- add post ---------- */
$('#btnPost').onclick = async ()=>{
  if(!currentUser) return toast('ƒêƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng b√†i');
  const content = postContent.value.trim();
  if(!content) return toast('N·ªôi dung r·ªóng');
  if(!currentUser.isAdmin){
    const last = currentUser.lastPostAt || 0;
    if(now() - last < 24*60*60*1000) return toast('B·∫°n ch·ªâ ƒë∆∞·ª£c ƒëƒÉng 1 l·∫ßn trong 24 gi·ªù');
  }
  if(!confirm('B·∫°n c√≥ mu·ªën ƒëƒÉng b√†i n√†y?')) return;
  const file = avatarFile.files[0];
  let imageURL = '';
  try{
    if(file){
      const path = `postImages/${Date.now()}_${file.name}`;
      imageURL = await uploadFileToStorage(file, path);
    }
    const postObj = {
      username: currentUser.name,
      authorAvatarUrl: currentUser.avatarUrl || '',
      authorAvatarData: currentUser.avatarData || '',
      content,
      imageURL,
      timestamp: serverTimestamp(),
      like: 0,
      comments: [],
      views: 0,
      viewers: [],
      reactions: {},
      userReactions: {}
    };
    await addDoc(collection(db,'posts'), postObj);
    if(currentUser && !currentUser.isAdmin){ currentUser.lastPostAt = now(); localStorage.setItem('ms_user', JSON.stringify(currentUser)); }
    postContent.value = ''; avatarFile.value = '';
    toast('ƒê√£ ƒëƒÉng b√†i');
  }catch(e){ console.error('add post err', e); toast('L·ªói khi th√™m b√†i'); }
};

/* ---------- auth flows ---------- */
$('#btnRegister').onclick = async ()=>{
  const un = regUser.value.trim(); const pw = regPass.value;
  if(!un || !pw) return toast('Nh·∫≠p t√™n & m·∫≠t kh·∫©u');
  if(un === 'admin'){ toast('Kh√¥ng th·ªÉ t·∫°o t√™n admin'); return; }
  try{
    const usersQ = query(collection(db,'users'), where('username','==',un), limit(1));
    const rs = await getDocs(usersQ);
    if(!rs.empty) return toast('T√†i kho·∫£n ƒë√£ t·ªìn t·∫°i');
    const avatarUrl = regAvatarUrl.value.trim() || '';
    await addDoc(collection(db,'users'), { username: un, password: pw, avatarUrl, createdAt: serverTimestamp(), lastPostAt: 0 });
    toast('ƒêƒÉng k√Ω th√†nh c√¥ng ‚Äî b·∫•m ƒëƒÉng nh·∫≠p');
    regUser.value=''; regPass.value=''; regAvatarUrl.value='';
    $('#btnShowLogin').click();
  }catch(e){ console.error(e); toast('L·ªói ƒëƒÉng k√Ω'); }
};

$('#btnShowLogin').onclick = ()=>{ $('#registerPanel').style.display='none'; $('#loginPanel').style.display='block'; };
$('#btnShowReg').onclick = ()=>{ $('#registerPanel').style.display='block'; $('#loginPanel').style.display='none'; };

$('#btnLogin').onclick = async ()=>{
  const un = loginUser.value.trim(); const pw = loginPass.value;
  if(!un || !pw) return toast('Nh·∫≠p t√™n & m·∫≠t kh·∫©u');
  if(un === 'admin' && pw === 'admin'){ currentUser = { name:'admin', isAdmin:true, avatarUrl:'', avatarData:'', lastPostAt:0 }; onLogin(); return; }
  try{
    const q = query(collection(db,'users'), where('username','==', un), limit(1));
    const r = await getDocs(q);
    if(r.empty) return toast('T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i');
    const docu = r.docs[0].data();
    if(docu.password !== pw) return toast('Sai m·∫≠t kh·∫©u');
    currentUser = { name: un, isAdmin: false, avatarUrl: docu.avatarUrl || '', avatarData: docu.avatarData || '', lastPostAt: docu.lastPostAt || 0, uid: uid() };
    localStorage.setItem('ms_user', JSON.stringify(currentUser));
    if($('#loginAvatarUrl').value.trim()){ const newUrl = $('#loginAvatarUrl').value.trim(); const uDoc = r.docs[0].ref; await updateDoc(uDoc, { avatarUrl: newUrl }); currentUser.avatarUrl = newUrl; $('#loginAvatarUrl').value=''; }
    onLogin();
  }catch(e){ console.error(e); toast('L·ªói login'); }
};

function onLogin(){
  $('#authBox').style.display='none'; composer.style.display='block'; btnLogout.style.display='inline-block';
  whoInfo.innerText = `B·∫°n: ${currentUser.name}${currentUser.isAdmin?' (admin)':''}`;
  toast('ƒêƒÉng nh·∫≠p: '+currentUser.name);
}

$('#btnLogout').onclick = ()=>{ currentUser = null; localStorage.removeItem('ms_user'); $('#authBox').style.display='block'; composer.style.display='none'; btnLogout.style.display='none'; whoInfo.innerText=''; toast('ƒê√£ ƒëƒÉng xu·∫•t'); };

$('#btnForgot').onclick = async ()=>{
  const who = fpUser.value.trim() || prompt('T√™n t√†i kho·∫£n ƒë·ªÉ reset:');
  if(!who) return;
  if(who === 'admin'){ return toast('Kh√¥ng reset admin qua giao di·ªán'); }
  try{
    const q = query(collection(db,'users'), where('username','==', who), limit(1));
    const r = await getDocs(q);
    if(r.empty) return toast('T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i');
    const code = prompt('Nh·∫≠p m√£ ƒë·ªïi m·∫≠t kh·∫©u (m·∫∑c ƒë·ªãnh 0):');
    if(code === '0'){ const np = prompt('Nh·∫≠p m·∫≠t kh·∫©u m·ªõi:'); const refUser = r.docs[0].ref; await updateDoc(refUser, { password: np }); toast('ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u'); } else toast('M√£ sai');
  }catch(e){ console.error(e); toast('L·ªói forgot'); }
};

(function restoreLocalUser(){ const su = localStorage.getItem('ms_user'); if(su){ try{ currentUser = JSON.parse(su); onLogin(); }catch(e){} } })();

/* ---------- music ---------- */
function populateMusic(){ musicSelect.innerHTML = '<option value="">-- ch·ªçn nh·∫°c --</option>'; musicList.forEach((m,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=m.title || m.url; musicSelect.appendChild(o); }); }
populateMusic();
musicSelect.onchange = ()=> { const i = musicSelect.value; if(i===''){ bgMusic.pause(); bgMusic.src=''; } else { bgMusic.src = musicList[i].url; bgMusic.play().catch(()=>{}); } }
musicPlay.onclick = ()=> { if(bgMusic.paused) bgMusic.play().catch(()=>toast('Autoplay ch·∫∑n')); else bgMusic.pause(); }
btnAddMusic.onclick = ()=>{ const url = prompt('D√°n URL mp3 (http/https):'); if(!url) return; const title = prompt('Ti√™u ƒë·ªÅ (b·ªè tr·ªëng ƒë·ªÉ l·∫•y t√™n file)') || url.split('/').pop(); musicList.push({url,title}); saveLocalMusic(); populateMusic(); }
btnPrev.onclick = ()=>{ if(!musicList.length) return; let i = Number(musicSelect.value || 0); i = (i-1+musicList.length)%musicList.length; musicSelect.value = i; musicSelect.onchange(); }
btnNext.onclick = ()=>{ if(!musicList.length) return; let i = Number(musicSelect.value || 0); i = (i+1)%musicList.length; musicSelect.value = i; musicSelect.onchange(); }
function saveLocalMusic(){ localStorage.setItem('ms_music', JSON.stringify(musicList)); }
(function loadLocalMusic(){ const m = localStorage.getItem('ms_music'); if(m){ try{ musicList = JSON.parse(m); }catch(e){} } populateMusic(); })();

/* ---------- theme ---------- */
themeToggle.onclick = ()=>{ const cur = document.documentElement.getAttribute('data-theme'); const next = cur === 'light' ? '' : 'light'; document.documentElement.setAttribute('data-theme', next); localStorage.setItem('ms_theme', next); }
(function restoreTheme(){ const t = localStorage.getItem('ms_theme')||''; document.documentElement.setAttribute('data-theme', t); })();

/* ---------- cleanup old posts (attempt) ---------- */
setInterval(async ()=>{
  try{
    const cutoff = new Date(Date.now() - 24*60*60*1000);
    const q = query(collection(db,'posts'), where('timestamp','<', cutoff), limit(50));
    const snaps = await getDocs(q);
    snaps.forEach(async d => { try{ await deleteDoc(doc(db,'posts',d.id)); }catch(e){} });
  }catch(e){}
}, 60*1000);

/* ---------- boot realtime ---------- */
startRealtime();

/* ---------- small helpers ---------- */
function showSmall(t){ toast(t,1600); }

</script>
</body>
</html>
