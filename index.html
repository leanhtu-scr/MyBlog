<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Social — Single File</title>
<style>
  :root{
    --bg:#f3f6fb; --card:#fff; --muted:#64748b; --text:#0f172a;
    --primary:#0ea5e9; --danger:#ef4444; --success:#16a34a; --border:#e6eef6;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:var(--text);background:linear-gradient(180deg,#ffffff,var(--bg))}
  .container{max-width:900px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 0}
  .brand{display:inline-flex;align-items:center;gap:10px}
  .badge{background:var(--card);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-weight:600}
  .btn{appearance:none;border:1px solid var(--border);background:var(--card);padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn.ghost{background:transparent}
  .btn.destructive{background:var(--danger);border-color:var(--danger);color:#fff}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
  .auth-wrap{min-height:78vh;display:grid;place-items:center;padding:30px}
  .auth-card{width:100%;max-width:480px}
  input, textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#fff}
  textarea{min-height:120px;resize:vertical;padding-top:12px}
  .tabs{display:flex;border-radius:12px;overflow:hidden;border:1px solid var(--border);margin-bottom:14px}
  .tabs button{flex:1;padding:12px;border:0;background:transparent;cursor:pointer}
  .tabs button.active{background:var(--bg);font-weight:700}
  .muted{color:var(--muted)}
  .center{display:grid;place-items:center}
  .feed{max-width:760px;margin:18px auto;display:grid;gap:14px;padding-bottom:30px}
  .composer{margin-bottom:6px}
  .post-meta{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .emoji{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);cursor:pointer;margin-right:8px}
  .emoji.active{outline:2px solid rgba(14,165,233,0.18)}
  .emojis{display:flex;flex-wrap:wrap;gap:8px}
  .comments{max-height:220px;overflow:auto;border-top:1px solid var(--border);padding-top:8px;margin-top:8px}
  .comment-item{padding:6px 0;border-bottom:1px dashed rgba(0,0,0,0.03);font-size:14px}
  .controls{display:flex;gap:8px;align-items:center}
  .nav-dots{display:flex;justify-content:center;gap:6px;margin-top:10px}
  .dot{height:6px;width:28px;border-radius:999px;background:#e2e8f0}
  .dot.active{background:#0f172a}
  .swipe-area{touch-action:pan-y}
  .small{font-size:13px;color:var(--muted)}
  @media (max-width:640px){
    .container{padding:10px}
    .feed{padding:0 6px}
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="badge">Mini Social</div>
        <div id="welcome" class="small muted" style="margin-left:10px"></div>
      </div>
      <div>
        <button id="logoutBtn" class="btn" style="display:none">Đăng xuất</button>
      </div>
    </header>

    <!-- AUTH -->
    <section id="auth" class="auth-wrap">
      <div class="auth-card card">
        <h2 style="margin:0 0 10px 0">Đăng nhập để tiếp tục</h2>
        <div class="tabs" role="tablist">
          <button id="tabLogin" class="active">Đăng nhập</button>
          <button id="tabRegister">Đăng ký</button>
          <button id="tabForgot">Quên mật khẩu</button>
        </div>

        <div id="paneLogin">
          <div style="margin-bottom:10px"><input id="liUser" placeholder="Tên tài khoản" autocomplete="username"></div>
          <div style="margin-bottom:12px"><input id="liPass" placeholder="Mật khẩu" type="password" autocomplete="current-password"></div>
          <button id="loginBtn" class="btn primary" style="width:100%">Đăng nhập</button>
        </div>

        <div id="paneRegister" style="display:none">
          <div style="margin-bottom:10px"><input id="reUser" placeholder="Tên tài khoản (cho phép dấu, ký tự đặc biệt)"></div>
          <div style="margin-bottom:10px"><input id="rePass" placeholder="Mật khẩu" type="password"></div>
          <div style="margin-bottom:12px"><input id="rePass2" placeholder="Nhập lại mật khẩu" type="password"></div>
          <button id="registerBtn" class="btn primary" style="width:100%">Tạo tài khoản</button>
          <div style="margin-top:10px" class="small muted">Sau khi đăng ký, hãy đăng nhập để vào trang chính.</div>
        </div>

        <div id="paneForgot" style="display:none">
          <div style="margin-bottom:10px"><input id="foUser" placeholder="Tên tài khoản"></div>
          <div style="margin-bottom:10px"><input id="foCode" placeholder="Mã khôi phục (mặc định là 0)"></div>
          <div style="margin-bottom:12px"><input id="foNew" placeholder="Mật khẩu mới" type="password"></div>
          <button id="forgotBtn" class="btn primary" style="width:100%">Đổi mật khẩu</button>
        </div>
      </div>
    </section>

    <!-- MAIN -->
    <section id="main" style="display:none">
      <div class="feed">

        <!-- admin composer (visible only to admin) -->
        <div id="composerWrap" class="card composer" style="display:none">
          <div class="post-meta">
            <strong>Soạn bài viết (chỉ admin)</strong>
            <div class="small muted">Bài sẽ tự xoá sau 15 giờ</div>
          </div>
          <div style="margin-top:10px">
            <textarea id="postText" placeholder="Viết gì đó..." ></textarea>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px">
            <button id="postBtn" class="btn primary">Đăng</button>
          </div>
        </div>

        <!-- Feed card -->
        <div class="card" id="feedCard">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <h3 style="margin:0">Bài đăng</h3>
            <div id="topCountdown" class="small muted"></div>
          </div>

          <div id="carousel" class="swipe-area" style="position:relative;min-height:260px">
            <button id="prev" class="btn ghost" style="position:absolute;left:6px;top:50%;transform:translateY(-50%);z-index:5">◀</button>
            <button id="next" class="btn ghost" style="position:absolute;right:6px;top:50%;transform:translateY(-50%);z-index:5">▶</button>

            <div id="postContainer" style="padding:12px 6px"></div>

            <div class="nav-dots" id="dotsWrap"></div>
          </div>
        </div>

      </div>
    </section>
  </div>

<script>
/* ---------------------------
   Data & Helpers (localStorage)
   --------------------------- */
const LS = {
  users: 'mini_social_users_v1',
  session: 'mini_social_session_v1',
  posts: 'mini_social_posts_v1'
};
const EXP_MS = 15*60*60*1000; // 15 hours
const EMOJIS = ["👍","❤️","😂","😮","😢","🔥","👏","🎉"];

function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function load(key, fallback){ try{ const v = JSON.parse(localStorage.getItem(key)); return v ?? fallback }catch(e){return fallback} }

/* Create default admin if not present */
(function ensureAdmin(){
  const users = load(LS.users, []);
  if(!users.some(u=>u.username==='admin')){
    // store password in SHA-256 (simple) for demo - but we salt/secure further in real app
    // For simplicity we will store plain hashed string using Web Crypto. On first run, it will be added.
    // We'll set recovery default to "0" as requested.
    hash('admin').then(h=>{
      users.push({ username:'admin', password:h, role:'admin', recovery:'0' });
      save(LS.users, users);
    });
  }
})();

/* SHA-256 helper */
async function hash(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* purge expired posts */
function purgeExpired(posts){
  const now = Date.now();
  const kept = posts.filter(p=> now - p.createdAt < EXP_MS);
  if(kept.length !== posts.length) save(LS.posts, kept);
  return kept;
}

/* format duration hh:mm:ss */
function fmtDuration(ms){
  ms = Math.max(0, ms);
  const s = Math.floor(ms/1000);
  const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

/* ---------------------------
   App State
   --------------------------- */
let state = {
  users: load(LS.users, []),
  session: load(LS.session, null),
  posts: purgeExpired(load(LS.posts, [])),
  index: 0, // carousel index (0 = newest)
  touch: { startX:0, dx:0 }
};

/* Keep storage in sync when state updates */
function persistUsers(){ save(LS.users, state.users); }
function persistSession(){ save(LS.session, state.session); }
function persistPosts(){ save(LS.posts, state.posts); }

/* ---------------------------
   UI Refs
   --------------------------- */
const authSection = document.getElementById('auth');
const mainSection = document.getElementById('main');
const welcomeEl = document.getElementById('welcome');
const logoutBtn = document.getElementById('logoutBtn');

const tabLogin = document.getElementById('tabLogin');
const tabRegister = document.getElementById('tabRegister');
const tabForgot = document.getElementById('tabForgot');
const paneLogin = document.getElementById('paneLogin');
const paneRegister = document.getElementById('paneRegister');
const paneForgot = document.getElementById('paneForgot');

const liUser = document.getElementById('liUser');
const liPass = document.getElementById('liPass');
const loginBtn = document.getElementById('loginBtn');

const reUser = document.getElementById('reUser');
const rePass = document.getElementById('rePass');
const rePass2 = document.getElementById('rePass2');
const registerBtn = document.getElementById('registerBtn');

const foUser = document.getElementById('foUser');
const foCode = document.getElementById('foCode');
const foNew = document.getElementById('foNew');
const forgotBtn = document.getElementById('forgotBtn');

const composerWrap = document.getElementById('composerWrap');
const postText = document.getElementById('postText');
const postBtn = document.getElementById('postBtn');

const postContainer = document.getElementById('postContainer');
const dotsWrap = document.getElementById('dotsWrap');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const topCountdown = document.getElementById('topCountdown');

/* ---------------------------
   Tab events
   --------------------------- */
function setActiveTab(tab){
  [tabLogin,tabRegister,tabForgot].forEach(t=>t.classList.remove('active'));
  if(tab==='login') tabLogin.classList.add('active');
  if(tab==='register') tabRegister.classList.add('active');
  if(tab==='forgot') tabForgot.classList.add('active');
  paneLogin.style.display = tab==='login' ? '' : 'none';
  paneRegister.style.display = tab==='register' ? '' : 'none';
  paneForgot.style.display = tab==='forgot' ? '' : 'none';
}
tabLogin.addEventListener('click', ()=> setActiveTab('login'));
tabRegister.addEventListener('click', ()=> setActiveTab('register'));
tabForgot.addEventListener('click', ()=> setActiveTab('forgot'));

/* ---------------------------
   Auth logic
   --------------------------- */
loginBtn.addEventListener('click', async ()=>{
  const username = liUser.value.trim();
  const password = liPass.value;
  if(!username || !password) return notify('Điền đầy đủ thông tin','error');
  const user = state.users.find(u=>u.username === username);
  if(!user) return notify('Tài khoản không tồn tại','error');
  const h = await hash(password);
  if(h !== user.password) return notify('Sai mật khẩu','error');
  state.session = { username: user.username, role: user.role };
  persistSession();
  notify('Đăng nhập thành công','ok');
  render();
});

registerBtn.addEventListener('click', async ()=>{
  const username = reUser.value.trim();
  const p1 = rePass.value, p2 = rePass2.value;
  if(!username || !p1 || !p2) return notify('Điền đầy đủ thông tin','error');
  if(p1 !== p2) return notify('Mật khẩu nhập lại không khớp','error');
  // Allow special characters and commas => accept raw string
  if(state.users.some(u=>u.username===username)) return notify('Tên tài khoản đã tồn tại','error');
  const h = await hash(p1);
  const rec = '0'; // default recovery code as requested
  state.users.push({ username, password: h, role: 'user', recovery: rec });
  persistUsers();
  notify('Đăng ký thành công. Mã khôi phục: 0','ok');
  setActiveTab('login');
});

forgotBtn.addEventListener('click', async ()=>{
  const username = foUser.value.trim();
  const code = foCode.value.trim();
  const newPw = foNew.value;
  if(!username || !code || !newPw) return notify('Điền đầy đủ thông tin','error');
  const idx = state.users.findIndex(u=>u.username===username);
  if(idx === -1) return notify('Không tìm thấy tài khoản','error');
  if(state.users[idx].recovery !== code) return notify('Mã khôi phục không đúng','error');
  const h = await hash(newPw);
  state.users[idx].password = h;
  persistUsers();
  notify('Đặt lại mật khẩu thành công','ok');
  setActiveTab('login');
});

/* ---------------------------
   Logout & Render Switching
   --------------------------- */
logoutBtn.addEventListener('click', ()=> {
  state.session = null;
  persistSession();
  render();
});

/* ---------------------------
   Posts management
   --------------------------- */
function addPost(content){
  const p = { id: crypto.randomUUID(), content: content.trim(), createdAt: Date.now(), comments: [], reactions: {} };
  state.posts = [p, ...state.posts];
  persistPosts();
  state.index = 0;
  renderPosts();
  notify('Đã đăng bài','ok');
}

postBtn.addEventListener('click', ()=>{
  const txt = postText.value.trim();
  if(!txt) return notify('Nội dung trống','error');
  addPost(txt);
  postText.value = '';
});

/* toggle reaction for current user */
function toggleReaction(postId, emoji){
  if(!state.session) { notify('Hãy đăng nhập để tương tác','error'); return; }
  state.posts = state.posts.map(p => {
    if(p.id !== postId) return p;
    const r = {...p.reactions};
    const set = new Set(r[emoji] || []);
    if(set.has(state.session.username)) set.delete(state.session.username); else set.add(state.session.username);
    r[emoji] = Array.from(set);
    return {...p, reactions: r};
  });
  persistPosts();
  renderPosts();
}

/* add comment */
function addComment(postId, text){
  if(!state.session) { notify('Hãy đăng nhập để bình luận','error'); return; }
  if(!text || !text.trim()) return;
  state.posts = state.posts.map(p => p.id===postId ? {...p, comments: [...p.comments, { id: crypto.randomUUID(), by: state.session.username, text: text.trim(), at: Date.now() }]} : p);
  persistPosts();
  renderPosts();
}

/* delete post (admin only) */
function deletePost(postId){
  if(!state.session || state.session.role !== 'admin'){ notify('Không có quyền','error'); return; }
  if(!confirm('Bạn có chắc muốn xoá bài viết này?')) return;
  state.posts = state.posts.filter(p=>p.id !== postId);
  persistPosts();
  state.index = Math.max(0, Math.min(state.index, state.posts.length-1));
  renderPosts();
  notify('Đã xoá bài','ok');
}

/* ---------------------------
   Render posts / carousel / comments (livestream)
   --------------------------- */
function render(){
  // refresh from storage (in case other tabs changed)
  state.users = load(LS.users, state.users);
  state.posts = purgeExpired(load(LS.posts, state.posts));
  state.session = load(LS.session, state.session);

  // auth vs main
  if(state.session){
    authSection.style.display = 'none';
    mainSection.style.display = '';
    logoutBtn.style.display = '';
    welcomeEl.textContent = `Xin chào, ${state.session.username}${state.session.role==='admin' ? ' (admin)' : ''}`;
    // show composer only for admin
    composerWrap.style.display = state.session.role==='admin' ? '' : 'none';
  }else{
    authSection.style.display = '';
    mainSection.style.display = 'none';
    logoutBtn.style.display = 'none';
    welcomeEl.textContent = '';
  }
  renderPosts();
}

/* render currently selected post */
function renderPosts(){
  state.posts = purgeExpired(state.posts);
  persistPosts();
  if(state.posts.length === 0){
    postContainer.innerHTML = '<div class="small muted" style="padding:18px;text-align:center">Chưa có bài đăng</div>';
    dotsWrap.innerHTML = '';
    topCountdown.textContent = '';
    return;
  }
  // ensure index valid
  if(state.index > state.posts.length-1) state.index = state.posts.length-1;
  if(state.index < 0) state.index = 0;

  // show current post (state.index: 0 newest)
  const post = [...state.posts].sort((a,b)=> b.createdAt - a.createdAt)[state.index];
  // we will render post (with emojis, comments)
  const node = document.createElement('div');
  node.innerHTML = `
    <div style="display:grid;gap:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><span style="background:#f1f5f9;border-radius:999px;padding:6px 10px;border:1px solid var(--border)">Bài của admin</span>
             <div class="small muted" style="margin-top:6px">Đăng lúc ${new Date(post.createdAt).toLocaleString()}</div>
        </div>
        <div style="text-align:right">
          <div class="small muted">Còn lại: <b id="leftTimer">${fmtDuration(EXP_MS - (Date.now() - post.createdAt))}</b></div>
          ${state.session && state.session.role==='admin' ? '<div style="margin-top:8px"><button id="delPostBtn" class="btn destructive">Xoá bài viết</button></div>' : ''}
        </div>
      </div>

      <div style="font-size:16px;line-height:1.5;white-space:pre-wrap">${escapeHtml(post.content)}</div>

      <div class="emojis" id="emojiRow"></div>

      <div class="card" style="padding:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Bình luận</strong>
          <div class="badge small muted">${post.comments.length} bình luận</div>
        </div>
        <div class="comments" id="commentList"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="commentInput" placeholder="Nhập bình luận và nhấn Enter" style="flex:1;border-radius:10px;border:1px solid var(--border);padding:10px"/>
          <button id="sendCmt" class="btn">Gửi</button>
        </div>
      </div>
    </div>
  `;
  postContainer.innerHTML = '';
  postContainer.appendChild(node);

  // build emojis
  const emojiRow = document.getElementById('emojiRow');
  EMOJIS.forEach(e=>{
    const btn = document.createElement('button');
    btn.className = 'emoji' + ((post.reactions && post.reactions[e] && post.reactions[e].includes(state.session ? state.session.username : '__anon__')) ? ' active' : '');
    btn.innerHTML = `<span style="font-size:18px">${e}</span><span class="small muted"> ${(post.reactions && post.reactions[e]) ? post.reactions[e].length : 0}</span>`;
    btn.addEventListener('click', ()=> toggleReaction(post.id, e));
    emojiRow.appendChild(btn);
  });

  // comments (livestream: append and auto-scroll to bottom)
  const cList = document.getElementById('commentList');
  (post.comments || []).forEach(c=>{
    const div = document.createElement('div');
    div.className = 'comment-item';
    const t = new Date(c.at).toLocaleTimeString();
    div.innerHTML = `<strong>${escapeHtml(c.by)}</strong> <span class="small muted">${t}</span><div>${escapeHtml(c.text)}</div>`;
    cList.appendChild(div);
  });
  // autoscroll to bottom (live)
  cList.scrollTop = cList.scrollHeight;

  // comment input events
  const commentInput = document.getElementById('commentInput');
  const sendCmt = document.getElementById('sendCmt');
  sendCmt.onclick = ()=> { addComment(post.id, commentInput.value); commentInput.value=''; };
  commentInput.onkeydown = (e)=> { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); addComment(post.id, commentInput.value); commentInput.value=''; } };

  // delete post
  const delBtn = document.getElementById('delPostBtn');
  if(delBtn) delBtn.onclick = ()=> deletePost(post.id);

  // update dots
  dotsWrap.innerHTML = '';
  const sorted = [...state.posts].sort((a,b)=> b.createdAt - a.createdAt);
  sorted.forEach((p,i)=>{
    const d = document.createElement('div');
    d.className = 'dot' + (i===state.index ? ' active' : '');
    d.style.cursor = 'pointer'; d.onclick = ()=> { state.index = i; renderPosts(); };
    dotsWrap.appendChild(d);
  });

  // update top countdown (time left of current)
  function updateLeft(){
    const leftMs = EXP_MS - (Date.now() - post.createdAt);
    document.getElementById('leftTimer') && (document.getElementById('leftTimer').textContent = fmtDuration(leftMs));
    topCountdown.textContent = leftMs>0 ? `Còn lại: ${fmtDuration(leftMs)}` : '';
    // auto-purge if expired
    if(leftMs <= 0){
      state.posts = state.posts.filter(x=> x.id !== post.id);
      persistPosts();
      // adjust index
      state.index = Math.max(0, Math.min(state.index, state.posts.length-1));
      // rerender
      renderPosts();
    }
  }
  updateLeft();
}

/* ---------------------------
   Swipe & nav buttons
   --------------------------- */
const carousel = document.getElementById('carousel');
carousel.addEventListener('touchstart', e=> { state.touch.startX = e.touches[0].clientX; state.touch.dx = 0; });
carousel.addEventListener('touchmove', e=> { state.touch.dx = e.touches[0].clientX - state.touch.startX; });
carousel.addEventListener('touchend', e=> {
  if(state.touch.dx > 50){ // swipe right -> next (older)
    state.index = Math.min(state.posts.length-1, state.index + 1);
    renderPosts();
  } else if(state.touch.dx < -50){ // swipe left -> prev (newer)
    state.index = Math.max(0, state.index - 1);
    renderPosts();
  }
  state.touch.dx = 0;
});

prevBtn.addEventListener('click', ()=> { state.index = Math.max(0, state.index - 1); renderPosts(); });
nextBtn.addEventListener('click', ()=> { state.index = Math.min(state.posts.length-1, state.index + 1); renderPosts(); });

/* ---------------------------
   Periodic tasks
   --------------------------- */
setInterval(()=> {
  // refresh countdown (if post visible)
  const leftEls = document.querySelectorAll('#leftTimer');
  leftEls.forEach(el=>{
    // left will be updated in renderPosts' updateLeft
  });
  // purge expired posts every 30s
  const before = state.posts.length;
  state.posts = purgeExpired(state.posts);
  if(state.posts.length !== before){
    persistPosts();
    state.index = Math.max(0, Math.min(state.index, state.posts.length-1));
    renderPosts();
  }
}, 30000);

/* ---------------------------
   Small utilities
   --------------------------- */
function notify(msg, type='info'){
  // simple floating notification
  const bg = (type==='error') ? '#ef4444' : (type==='ok' ? '#16a34a' : '#0ea5e9');
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.cssText = `position:fixed;left:50%;top:18px;transform:translateX(-50%);background:${bg};color:#fff;padding:10px 14px;border-radius:10px;z-index:9999;box-shadow:0 8px 32px rgba(2,6,23,0.12)`;
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 1800);
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }

/* ---------------------------
   Initial mount
   --------------------------- */
(function mount(){
  // ensure state users is synced from storage (in case ensureAdmin added late)
  state.users = load(LS.users, state.users);

  // attach logout button visibility
  if(state.session) logoutBtn.style.display='';

  // If session exists -> show main; else show auth
  render();

  // small UX: allow Enter to login quickly
  liPass.addEventListener('keydown', e=> { if(e.key==='Enter') loginBtn.click(); });
})();

</script>
</body>
</html>
